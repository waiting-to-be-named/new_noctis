<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noctis - Advanced DICOM Viewer Pro</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dicom_viewer_advanced.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
</head>
<body>
    <div class="dicom-viewer-advanced">
            <div id="viewer-errors" style="position: fixed; top: 70px; right: 20px; z-index: 9999; max-width: 400px;">
                <!-- Error messages will be displayed here -->
            </div>
        <!-- Advanced Professional Header -->
        <div class="viewer-header-advanced">
            <div class="header-left">
                <div class="viewer-title-advanced">
                    <i class="fas fa-brain"></i>
                    Noctis DICOM Viewer Pro
                    <span class="version-badge">v3.0</span>
                </div>
                <div class="patient-quick-info">
                    <span id="quick-patient-name">-</span> | 
                    <span id="quick-patient-id">-</span> | 
                    <span id="quick-modality">-</span>
                </div>
            </div>
            <div class="header-center">
                <div class="navigation-controls">
                    <button class="nav-btn" id="prev-study-btn" title="Previous Study">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="study-counter" id="study-counter">Study 1 of 1</span>
                    <button class="nav-btn" id="next-study-btn" title="Next Study">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="back-to-worklist-btn" title="Back to Worklist" onclick="window.location.href='/worklist/'">
                    <i class="fas fa-arrow-left"></i>
                    Worklist
                </button>
                <button class="header-btn" id="upload-advanced-btn" title="Advanced Upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Upload
                </button>
                <button class="header-btn" id="export-btn" title="Export Study">
                    <i class="fas fa-download"></i>
                    Export
                </button>
                <button class="header-btn" id="settings-btn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn" id="fullscreen-btn" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="header-btn" id="logout-advanced-btn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Advanced Patient Information Panel -->
        <div class="patient-info-advanced">
            <div class="patient-info-grid">
                <div class="info-group">
                    <div class="info-item">
                        <label>Patient Name:</label>
                        <span id="patient-name-adv">-</span>
                    </div>
                    <div class="info-item">
                        <label>Patient ID:</label>
                        <span id="patient-id-adv">-</span>
                    </div>
                    <div class="info-item">
                        <label>Date of Birth:</label>
                        <span id="patient-dob">-</span>
                    </div>
                </div>
                <div class="info-group">
                    <div class="info-item">
                        <label>Study Date:</label>
                        <span id="study-date-adv">-</span>
                    </div>
                    <div class="info-item">
                        <label>Study Description:</label>
                        <span id="study-description-adv">-</span>
                    </div>
                    <div class="info-item">
                        <label>Modality:</label>
                        <span id="modality-adv">-</span>
                    </div>
                </div>
                <div class="info-group">
                    <div class="info-item">
                        <label>Series:</label>
                        <span id="series-count">-</span>
                    </div>
                    <div class="info-item">
                        <label>Images:</label>
                        <span id="image-count-adv">-</span>
                    </div>
                    <div class="info-item">
                        <label>Institution:</label>
                        <span id="institution-name">-</span>
                    </div>
                </div>
            </div>
            <div class="patient-info-toggle">
                <button id="toggle-patient-info" title="Toggle Patient Info">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content-advanced">
            <!-- Advanced Left Toolbar -->
            <div class="left-toolbar-advanced">
                <!-- Tool Groups -->
                <div class="tool-group-advanced" data-group="navigation">
                    <div class="group-header">
                        <i class="fas fa-arrows-alt"></i>
                        Navigation
                    </div>
                    <button class="tool-btn-advanced active" id="windowing-adv-btn" title="Window/Level (W)" data-key="w">
                        <i class="fas fa-adjust"></i>
                        <span>Window</span>
                    </button>
                    <button class="tool-btn-advanced" id="pan-adv-btn" title="Pan (P)" data-key="p">
                        <i class="fas fa-hand-paper"></i>
                        <span>Pan</span>
                    </button>
                    <button class="tool-btn-advanced" id="zoom-adv-btn" title="Zoom (Z)" data-key="z">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom</span>
                    </button>
                    <button class="tool-btn-advanced" id="rotate-btn" title="Rotate (R)" data-key="r">
                        <i class="fas fa-redo-alt"></i>
                        <span>Rotate</span>
                    </button>
                    <button class="tool-btn-advanced" id="flip-btn" title="Flip (F)" data-key="f">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Flip</span>
                    </button>
                </div>

                <div class="tool-group-advanced" data-group="measurement">
                    <div class="group-header">
                        <i class="fas fa-ruler"></i>
                        Measurement
                    </div>
                    <button class="tool-btn-advanced" id="measure-distance-btn" title="Distance (D)" data-key="d">
                        <i class="fas fa-ruler"></i>
                        <span>Distance</span>
                    </button>
                    <button class="tool-btn-advanced" id="measure-angle-btn" title="Angle (A)" data-key="a">
                        <i class="fas fa-drafting-compass"></i>
                        <span>Angle</span>
                    </button>
                    <button class="tool-btn-advanced" id="measure-area-btn" title="Area" data-key="">
                        <i class="fas fa-vector-square"></i>
                        <span>Area</span>
                    </button>
                    <button class="tool-btn-advanced" id="measure-volume-btn" title="Volume" data-key="">
                        <i class="fas fa-cube"></i>
                        <span>Volume</span>
                    </button>
                    <button class="tool-btn-advanced" id="hu-measurement-btn" title="HU Measurement" data-key="">
                        <i class="fas fa-crosshairs"></i>
                        <span>HU</span>
                    </button>
                </div>

                <div class="tool-group-advanced" data-group="annotation">
                    <div class="group-header">
                        <i class="fas fa-comment"></i>
                        Annotation
                    </div>
                    <button class="tool-btn-advanced" id="text-annotation-btn" title="Text Annotation (T)" data-key="t">
                        <i class="fas fa-font"></i>
                        <span>Text</span>
                    </button>
                    <button class="tool-btn-advanced" id="arrow-annotation-btn" title="Arrow" data-key="">
                        <i class="fas fa-arrow-right"></i>
                        <span>Arrow</span>
                    </button>
                    <button class="tool-btn-advanced" id="circle-annotation-btn" title="Circle" data-key="">
                        <i class="fas fa-circle"></i>
                        <span>Circle</span>
                    </button>
                    <button class="tool-btn-advanced" id="rectangle-annotation-btn" title="Rectangle" data-key="">
                        <i class="fas fa-square"></i>
                        <span>Rectangle</span>
                    </button>
                </div>

                <div class="tool-group-advanced" data-group="enhancement">
                    <div class="group-header">
                        <i class="fas fa-magic"></i>
                        Enhancement
                    </div>
                    <button class="tool-btn-advanced" id="invert-adv-btn" title="Invert (I)" data-key="i">
                        <i class="fas fa-adjust"></i>
                        <span>Invert</span>
                    </button>
                    <button class="tool-btn-advanced" id="crosshair-adv-btn" title="Crosshair (C)" data-key="c">
                        <i class="fas fa-crosshairs"></i>
                        <span>Crosshair</span>
                    </button>
                    <button class="tool-btn-advanced" id="magnify-btn" title="Magnifying Glass (M)" data-key="m">
                        <i class="fas fa-search"></i>
                        <span>Magnify</span>
                    </button>
                    <button class="tool-btn-advanced" id="sharpen-btn" title="Sharpen" data-key="">
                        <i class="fas fa-eye"></i>
                        <span>Sharpen</span>
                    </button>
                </div>

                <div class="tool-group-advanced" data-group="3d">
                    <div class="group-header">
                        <i class="fas fa-cube"></i>
                        3D/MPR
                    </div>
                    <button class="tool-btn-advanced" id="mpr-btn" title="Multi-Planar Reconstruction" data-key="">
                        <i class="fas fa-th"></i>
                        <span>MPR</span>
                    </button>
                    <button class="tool-btn-advanced" id="volume-render-btn" title="Volume Rendering" data-key="">
                        <i class="fas fa-cube"></i>
                        <span>Volume</span>
                    </button>
                    <button class="tool-btn-advanced" id="mip-btn" title="Maximum Intensity Projection" data-key="">
                        <i class="fas fa-layer-group"></i>
                        <span>MIP</span>
                    </button>
                </div>

                <div class="tool-group-advanced" data-group="ai">
                    <div class="group-header">
                        <i class="fas fa-brain"></i>
                        AI Analysis
                    </div>
                    <button class="tool-btn-advanced" id="ai-analysis-btn" title="AI Analysis" data-key="">
                        <i class="fas fa-robot"></i>
                        <span>Analyze</span>
                    </button>
                    <button class="tool-btn-advanced" id="ai-segment-btn" title="AI Segmentation" data-key="">
                        <i class="fas fa-puzzle-piece"></i>
                        <span>Segment</span>
                    </button>
                </div>

                <div class="tool-group-advanced" data-group="utility">
                    <div class="group-header">
                        <i class="fas fa-tools"></i>
                        Utility
                    </div>
                    <button class="tool-btn-advanced" id="reset-adv-btn" title="Reset View (Esc)" data-key="Escape">
                        <i class="fas fa-undo"></i>
                        <span>Reset</span>
                    </button>
                    <button class="tool-btn-advanced" id="fit-to-window-btn" title="Fit to Window" data-key="">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>Fit</span>
                    </button>
                    <button class="tool-btn-advanced" id="actual-size-btn" title="Actual Size" data-key="">
                        <i class="fas fa-compress-arrows-alt"></i>
                        <span>1:1</span>
                    </button>
                </div>
            </div>

            <!-- Central Viewing Area -->
            <div class="central-viewer-area">
                <!-- Viewport Controls -->
                <div class="viewport-controls">
                    <div class="viewport-info">
                        <span id="zoom-level">100%</span> |
                        <span id="window-info">W: 1500 L: -600</span> |
                        <span id="slice-info">Slice: 1/1</span>
                    </div>
                    <div class="viewport-actions">
                        <button class="viewport-btn" id="layout-1x1-btn" title="1x1 Layout">
                            <i class="fas fa-square"></i>
                        </button>
                        <button class="viewport-btn" id="layout-2x2-btn" title="2x2 Layout">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="viewport-btn" id="layout-1x2-btn" title="1x2 Layout">
                            <i class="fas fa-columns"></i>
                        </button>
                        <button class="viewport-btn" id="sync-viewports-btn" title="Sync Viewports">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>

                <!-- Main Canvas Container -->
                <div class="canvas-container" id="canvas-container" style="position: relative; width: 100%; height: 600px; background: #000;">
                    <canvas id="dicom-canvas-advanced" class="dicom-canvas-advanced" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                    <div class="canvas-overlay" id="canvas-overlay">
                        <!-- Overlay elements like measurements, annotations -->
                        <div class="measurement-overlay" id="measurement-overlay"></div>
                        <div class="annotation-overlay" id="annotation-overlay"></div>
                        <div class="crosshair-overlay" id="crosshair-overlay"></div>
                        <div class="magnify-overlay" id="magnify-overlay"></div>
                    </div>
                    <div class="loading-indicator" id="loading-indicator">
                        <div class="spinner"></div>
                        <span>Loading DICOM...</span>
                    </div>
                </div>

                <!-- Thumbnail Navigator -->
                <div class="thumbnail-navigator">
                    <div class="thumbnail-header">
                        <span>Images</span>
                        <button id="thumbnail-toggle" title="Toggle Thumbnails">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="thumbnail-container" id="thumbnail-container">
                        <!-- Thumbnails will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Right Control Panel -->
            <div class="right-panel-advanced">
                <!-- Window/Level Presets -->
                <div class="control-panel" id="window-level-panel">
                    <div class="panel-header">
                        <i class="fas fa-adjust"></i>
                        Window/Level Presets
                    </div>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="lung">Lung</button>
                        <button class="preset-btn" data-preset="bone">Bone</button>
                        <button class="preset-btn" data-preset="soft">Soft Tissue</button>
                        <button class="preset-btn" data-preset="brain">Brain</button>
                        <button class="preset-btn" data-preset="abdomen">Abdomen</button>
                        <button class="preset-btn" data-preset="mediastinum">Mediastinum</button>
                    </div>
                    <div class="manual-controls">
                        <div class="control-group">
                            <label>Window Width:</label>
                            <input type="range" id="window-width-slider" min="1" max="4000" value="1500">
                            <input type="number" id="window-width-input" value="1500">
                        </div>
                        <div class="control-group">
                            <label>Window Level:</label>
                            <input type="range" id="window-level-slider" min="-1000" max="1000" value="-600">
                            <input type="number" id="window-level-input" value="-600">
                        </div>
                    </div>
                </div>

                <!-- Series Navigator -->
                <div class="control-panel" id="series-panel">
                    <div class="panel-header">
                        <i class="fas fa-layer-group"></i>
                        Series Navigator
                    </div>
                    <div class="series-list" id="series-list">
                        <!-- Series will be populated dynamically -->
                    </div>
                </div>

                <!-- Measurements Panel -->
                <div class="control-panel" id="measurements-panel">
                    <div class="panel-header">
                        <i class="fas fa-ruler-combined"></i>
                        Measurements
                        <button class="clear-btn" id="clear-measurements-btn" title="Clear All">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="measurements-list" id="measurements-list">
                        <!-- Measurements will be populated dynamically -->
                    </div>
                </div>

                <!-- Annotations Panel -->
                <div class="control-panel" id="annotations-panel">
                    <div class="panel-header">
                        <i class="fas fa-comment-medical"></i>
                        Annotations
                        <button class="clear-btn" id="clear-annotations-btn" title="Clear All">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="annotations-list" id="annotations-list">
                        <!-- Annotations will be populated dynamically -->
                    </div>
                </div>

                <!-- AI Analysis Panel -->
                <div class="control-panel" id="ai-panel">
                    <div class="panel-header">
                        <i class="fas fa-brain"></i>
                        AI Analysis
                    </div>
                    <div class="ai-controls">
                        <button class="ai-btn" id="ai-detect-lesions">Detect Lesions</button>
                        <button class="ai-btn" id="ai-segment-organs">Segment Organs</button>
                        <button class="ai-btn" id="ai-calculate-volume">Calculate Volume</button>
                    </div>
                    <div class="ai-results" id="ai-results">
                        <!-- AI results will be populated dynamically -->
                    </div>
                </div>

                <!-- Image Information Panel -->
                <div class="control-panel" id="image-info-panel">
                    <div class="panel-header">
                        <i class="fas fa-info-circle"></i>
                        Image Information
                    </div>
                    <div class="image-info-content" id="image-info-content">
                        <!-- Image metadata will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar-advanced">
            <div class="status-left">
                <span id="status-text">Ready</span>
            </div>
            <div class="status-center">
                <span id="pixel-info">Pixel: - HU: -</span>
            </div>
            <div class="status-right">
                <span id="coords-info">X: - Y: -</span>
                <span class="separator">|</span>
                <span id="memory-usage">Memory: -</span>
            </div>
        </div>
    </div>

    <!-- Modal Dialogs -->
    <!-- Export Dialog -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export Study</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="export-options">
                        <div class="option-group">
                            <h6>Export Format</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="exportDicom" value="dicom" checked>
                                <label class="form-check-label" for="exportDicom">DICOM Files</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="exportJpeg" value="jpeg">
                                <label class="form-check-label" for="exportJpeg">JPEG Images</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="exportPng" value="png">
                                <label class="form-check-label" for="exportPng">PNG Images</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportFormat" id="exportPdf" value="pdf">
                                <label class="form-check-label" for="exportPdf">PDF Report</label>
                            </div>
                        </div>
                        <div class="option-group">
                            <h6>Include</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeMeasurements" checked>
                                <label class="form-check-label" for="includeMeasurements">Measurements</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeAnnotations" checked>
                                <label class="form-check-label" for="includeAnnotations">Annotations</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeMetadata">
                                <label class="form-check-label" for="includeMetadata">DICOM Metadata</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmExport">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Dialog -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Viewer Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="settings-tabs">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#display-settings">Display</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#performance-settings">Performance</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#hotkeys-settings">Hotkeys</button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="display-settings">
                                <div class="setting-group">
                                    <label>Default Window Preset:</label>
                                    <select class="form-select" id="defaultWindowPreset">
                                        <option value="lung">Lung</option>
                                        <option value="bone">Bone</option>
                                        <option value="soft">Soft Tissue</option>
                                        <option value="brain">Brain</option>
                                    </select>
                                </div>
                                <div class="setting-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableSmoothing">
                                        <label class="form-check-label" for="enableSmoothing">Enable Image Smoothing</label>
                                    </div>
                                </div>
                                <div class="setting-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showOverlays" checked>
                                        <label class="form-check-label" for="showOverlays">Show Overlay Information</label>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="performance-settings">
                                <div class="setting-group">
                                    <label>Image Cache Size (MB):</label>
                                    <input type="range" class="form-range" id="cacheSize" min="100" max="2000" value="500">
                                    <span id="cacheSizeValue">500 MB</span>
                                </div>
                                <div class="setting-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableGPUAcceleration">
                                        <label class="form-check-label" for="enableGPUAcceleration">Enable GPU Acceleration</label>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="hotkeys-settings">
                                <div class="hotkey-list">
                                    <div class="hotkey-item">
                                        <span>Window/Level Tool:</span>
                                        <kbd>W</kbd>
                                    </div>
                                    <div class="hotkey-item">
                                        <span>Pan Tool:</span>
                                        <kbd>P</kbd>
                                    </div>
                                    <div class="hotkey-item">
                                        <span>Zoom Tool:</span>
                                        <kbd>Z</kbd>
                                    </div>
                                    <div class="hotkey-item">
                                        <span>Reset View:</span>
                                        <kbd>Esc</kbd>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSettings">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Advanced DICOM Upload</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h5>Drag & Drop DICOM Files Here</h5>
                            <p>or click to browse files</p>
                            <input type="file" id="fileInput" multiple accept=".dcm,.dicom" style="display: none;">
                        </div>
                    </div>
                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="upload-status" id="uploadStatus">Uploading...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="startUpload" disabled>Upload Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="{% static 'js/dicom_viewer_advanced.js' %}"></script>
    <script src="{% static 'js/dicom_viewer_enhanced_debug.js' %}"></script>
    <script src="{% static 'js/dicom_viewer_button_fixes.js' %}"></script>
    <script src="{% static 'js/dicom_viewer_comprehensive_fix.js' %}"></script>
    <script src="{% static 'js/viewer_worklist_fix.js' %}"></script>
    <script src="{% static 'js/viewer_study_loader_fix.js' %}"></script>
    <script src="{% static 'js/dicom_viewer_image_fix.js' %}"></script>
    
    <script>
        // Global function to launch viewer with specific study
        window.launchViewerWithStudy = function(studyId) {
            const url = new URL(window.location);
            url.pathname = `/viewer/study/${studyId}/`;
            window.location.href = url.toString();
        };
        
        // Initialize the advanced DICOM viewer when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a moment for all scripts to fully load
            setTimeout(() => {
                // Get study ID from Django context or URL parameters
                {% if initial_study_id %}
                    let studyId = {{ initial_study_id }};
                    console.log('Study ID from Django context:', studyId);
                {% else %}
                    let studyId = null;
                {% endif %}
                
                // Also check URL parameters for study ID (for standalone launches)
                const urlParams = new URLSearchParams(window.location.search);
                const urlStudyId = urlParams.get('study_id') || urlParams.get('studyId');
                if (urlStudyId) {
                    const parsedUrlStudyId = parseInt(urlStudyId);
                    if (!isNaN(parsedUrlStudyId)) {
                        studyId = parsedUrlStudyId;
                        console.log('Found study ID in URL parameters:', studyId);
                    }
                }
                
                // Check if study ID is in the path (for URLs like /viewer/study/123/)
                const pathMatch = window.location.pathname.match(/\/study\/(\d+)\//);
                if (pathMatch) {
                    const parsedPathStudyId = parseInt(pathMatch[1]);
                    if (!isNaN(parsedPathStudyId)) {
                        studyId = parsedPathStudyId;
                        console.log('Found study ID in URL path:', studyId);
                    }
                }
                
                console.log('Final resolved study ID:', studyId);
                
                // Check if AdvancedDicomViewer is available
                if (typeof AdvancedDicomViewer !== 'undefined') {
                    // Initialize the advanced viewer
                    window.advancedViewer = new AdvancedDicomViewer(studyId);
                    
                    // Set up global keyboard shortcuts
                    document.addEventListener('keydown', function(e) {
                        if (window.advancedViewer && window.advancedViewer.handleKeyboardShortcut) {
                            window.advancedViewer.handleKeyboardShortcut(e);
                        }
                    });
                } else {
                    console.error('AdvancedDicomViewer class not found! Check if dicom_viewer_advanced.js loaded correctly.');
                    // Try to reload the script
                    const script = document.createElement('script');
                    script.src = "{% static 'js/dicom_viewer_advanced.js' %}";
                    script.onload = function() {
                        console.log('Script reloaded, trying initialization again...');
                        if (typeof AdvancedDicomViewer !== 'undefined') {
                            window.advancedViewer = new AdvancedDicomViewer(studyId);
                        }
                    };
                    document.head.appendChild(script);
                }
            }, 100);
        });
    </script>

            <div id="debug-panel" style="position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 8px; font-size: 12px; z-index: 9999; max-width: 350px; font-family: monospace; line-height: 1.6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="font-size: 14px;">🔧 Debug Info</strong>
                    <button onclick="this.parentElement.parentElement.style.display='none'" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px;">×</button>
                </div>
                <div id="debug-canvas" style="color: #00ff88;">Canvas: Not initialized</div>
                <div id="debug-study" style="color: #00ff88;">Study: None loaded</div>
                <div id="debug-images" style="color: #00ff88;">Images: 0</div>
                <div id="debug-api" style="color: #00ff88;">API Status: Unknown</div>
                <div id="debug-tool" style="color: #00ff88;">Active Tool: None</div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                    <div style="color: #ffaa00;">Quick Actions:</div>
                    <button onclick="window.dicomViewerFixes && window.dicomViewerFixes.applyAllFixes()" style="margin-top: 5px; padding: 5px 10px; background: #0088ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Reapply Fixes</button>
                    <button onclick="location.reload()" style="margin-top: 5px; margin-left: 5px; padding: 5px 10px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Reload Page</button>
                </div>
            </div>
</body>
</html>