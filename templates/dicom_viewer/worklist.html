<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Worklist</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/worklist.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="worklist-container">
        <!-- Top Navigation Bar -->
        <div class="top-nav">
            <div class="nav-left">
                <h1><i class="fas fa-list-alt"></i> DICOM Worklist</h1>
                <span class="facility-name">{{ user_profile.facility.name|default:"All Facilities" }}</span>
            </div>
            <div class="nav-center">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search patients, studies..." class="search-input">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="nav-right">
                <div class="notifications" id="notifications-container">
                    <i class="fas fa-bell notification-icon" id="notification-bell"></i>
                    <span class="notification-count" id="notification-count">0</span>
                </div>
                <div class="user-info">
                    <span class="user-name">{{ user.get_full_name|default:user.username }}</span>
                    <span class="user-role">{{ user_profile.get_role_display }}</span>
                </div>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="location.href='{% url "viewer:viewer_main" %}'">
                        <i class="fas fa-eye"></i> Viewer
                    </button>
                    {% if user_profile.role != 'facility_user' %}
                    <button class="btn btn-secondary" onclick="location.href='{% url "viewer:facility_dashboard" %}'">
                        <i class="fas fa-building"></i> Facilities
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>Date Range:</label>
                <input type="date" id="date-from" class="filter-input">
                <span>to</span>
                <input type="date" id="date-to" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Modality:</label>
                <select id="modality-filter" class="filter-select">
                    <option value="">All</option>
                    <option value="CT">CT</option>
                    <option value="MRI">MRI</option>
                    <option value="CR">CR</option>
                    <option value="DR">DR</option>
                    <option value="US">US</option>
                    <option value="XA">XA</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select id="status-filter" class="filter-select">
                    <option value="">All</option>
                    <option value="new">New</option>
                    <option value="in_progress">In Progress</option>
                    <option value="reported">Reported</option>
                </select>
            </div>
            <button class="btn btn-accent" id="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Studies Table -->
        <div class="table-container">
            <table class="studies-table">
                <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Patient ID</th>
                        <th>Study Date</th>
                        <th>Modality</th>
                        <th>Description</th>
                        <th>Images</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studies-tbody">
                    {% for study in studies %}
                    <tr class="study-row" data-study-id="{{ study.id }}" onclick="selectStudy(this)">
                        <td class="patient-name">{{ study.patient_name }}</td>
                        <td class="patient-id">{{ study.patient_id }}</td>
                        <td class="study-date">{{ study.study_date|date:"Y-m-d" }}</td>
                        <td class="modality">
                            <span class="modality-badge modality-{{ study.modality|lower }}">{{ study.modality }}</span>
                        </td>
                        <td class="description">{{ study.study_description|truncatewords:8 }}</td>
                        <td class="image-count">{{ study.total_images }}</td>
                        <td class="status">
                            <span class="status-badge status-{{ study.is_processed|yesno:"reported,new" }}">
                                {{ study.is_processed|yesno:"Reported,New" }}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-primary view-btn" onclick="viewStudy({{ study.id }}); event.stopPropagation();">
                                <i class="fas fa-eye"></i> View
                            </button>
                            {% if user_profile.role in 'admin,radiologist' %}
                            <button class="btn btn-sm btn-secondary report-btn" onclick="openReportModal({{ study.id }}); event.stopPropagation();">
                                <i class="fas fa-file-medical"></i> Report
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="no-data">No studies found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Study Details Panel -->
        <div class="details-panel" id="details-panel" style="display: none;">
            <div class="panel-header">
                <h3><i class="fas fa-info-circle"></i> Study Details</h3>
                <button class="close-panel" onclick="closeDetailsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content" id="panel-content">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- Clinical Information Modal -->
        <div class="modal" id="clinical-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-user-md"></i> Clinical Information</h3>
                    <button class="modal-close" onclick="closeClinicalModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="clinical-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Patient Age:</label>
                                <input type="text" id="patient-age" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Patient Sex:</label>
                                <select id="patient-sex" class="form-select">
                                    <option value="">Select</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="O">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Weight (kg):</label>
                                <input type="number" id="patient-weight" class="form-input" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Height (cm):</label>
                                <input type="number" id="patient-height" class="form-input" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Referring Physician:</label>
                            <input type="text" id="referring-physician" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Clinical History:</label>
                            <textarea id="clinical-history" class="form-textarea" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Indication:</label>
                            <textarea id="indication" class="form-textarea" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Contrast Agent:</label>
                            <input type="text" id="contrast-agent" class="form-input">
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeClinicalModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Report Modal -->
        {% if user_profile.role in 'admin,radiologist' %}
        <div class="modal" id="report-modal" style="display: none;">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3><i class="fas fa-file-medical"></i> Radiology Report</h3>
                    <button class="modal-close" onclick="closeReportModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="report-form">
                        <div class="form-group">
                            <label>Findings:</label>
                            <textarea id="report-findings" class="form-textarea" rows="8" placeholder="Describe the radiological findings..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Impression:</label>
                            <textarea id="report-impression" class="form-textarea" rows="4" placeholder="Clinical impression and diagnosis..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Recommendations:</label>
                            <textarea id="report-recommendations" class="form-textarea" rows="3" placeholder="Recommendations for further care..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Status:</label>
                                <select id="report-status" class="form-select">
                                    <option value="draft">Draft</option>
                                    <option value="pending">Pending Review</option>
                                    <option value="finalized">Finalized</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Report</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Notifications Panel -->
        <div class="notifications-panel" id="notifications-panel" style="display: none;">
            <div class="panel-header">
                <h3><i class="fas fa-bell"></i> Notifications</h3>
                <button class="close-panel" onclick="closeNotificationsPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content" id="notifications-content">
                <!-- Dynamic notifications content -->
            </div>
        </div>
    </div>

    <script src="{% static 'js/worklist.js' %}"></script>
</body>
</html>