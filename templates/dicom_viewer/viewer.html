<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noctis - Enhanced DICOM Viewer</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dicom_viewer.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Enhanced viewer UI refinements */
        body {
            overflow: hidden;
            background: #000;
        }
        
        .dicom-viewer {
            background: #000;
        }
        
        /* Better button styles */
        .tool-btn {
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }
        
        /* Enhanced viewport appearance */
        .viewport {
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000 70%);
            border: 1px solid rgba(0, 255, 0, 0.1);
            transition: margin-bottom 0.3s ease;
            image-rendering: optimizeQuality;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* High-quality canvas rendering */
        #dicom-canvas {
            image-rendering: auto;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            will-change: transform;
        }
        
        /* Adjust viewport when series selector is shown */
        .dicom-viewer.series-selector-open .viewport {
            margin-bottom: 180px;
        }
        
        /* Better patient info display */
        .patient-info {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
            padding: 12px 20px;
            font-size: 14px;
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        
        /* Enhanced slider styling */
        .slider-control input[type="range"] {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .slider-control input[type="range"]:hover {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .slider-control .value {
            color: #00ff00;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.5);
        }
        
        /* Enhanced overlay labels */
        .overlay-label {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 4px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 255, 0, 0.2);
            font-size: 12px;
            line-height: 1.4;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .overlay-label.top-left,
        .overlay-label.top-right {
            top: 70px;
        }
        
        .overlay-label.bottom-left,
        .overlay-label.bottom-right {
            bottom: 20px;
        }
        
        /* Enhanced Series Selector Styles */
        .series-selector {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.95));
            color: white;
            padding: 15px;
            z-index: 12000;
            display: none;
            border-top: 2px solid #00ff00;
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }
        
        .series-selector.show {
            display: block;
            animation: slideUpFadeIn 0.3s ease-out;
        }
        
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Remove old position-specific styles */
        
        .series-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .series-selector-title {
            font-size: 16px;
            font-weight: bold;
            color: #00ff00;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .series-selector-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .series-selector-close:hover {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }
        
        .series-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .series-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 150px;
            flex-shrink: 0;
        }
        
        .series-item:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 0, 0.2);
        }
        
        .series-item.active {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .series-preview {
            width: 130px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 8px;
            background: #000;
            display: block;
        }
        
        .series-info {
            font-size: 11px;
            line-height: 1.3;
        }
        
        .series-number {
            font-weight: bold;
            color: #00ff00;
            font-size: 12px;
        }
        
        .series-description {
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 3px;
        }
        
        .series-count {
            color: #888;
            font-size: 10px;
            margin-top: 2px;
        }
        
        /* Simple Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            color: white;
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #00ff00;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #ff0000;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .upload-option-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .upload-option-btn:hover {
            border-color: #00ff00;
            background: #0a2a0a;
        }
        
        .upload-option-btn i {
            font-size: 24px;
            color: #00ff00;
            min-width: 30px;
        }
        
        .upload-option-btn span {
            font-size: 16px;
            font-weight: bold;
            display: block;
        }
        
        .upload-option-btn small {
            font-size: 12px;
            color: #888;
            display: block;
            margin-top: 2px;
        }
        

        

        
        /* Enhanced Controls */
        .enhanced-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-label {
            font-size: 12px;
            color: #666;
        }
        
        .control-toggle {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .control-toggle.active {
            background: #28a745;
        }
        
        /* Enhanced Image Processing Controls */
        .image-enhancement-panel {
            position: fixed;
            top: 120px;
            right: 20px;
            width: 280px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            z-index: 1500;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .image-enhancement-panel.show {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .enhancement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }
        
        .enhancement-title {
            color: #00ff00;
            font-size: 14px;
            font-weight: bold;
        }
        
        .enhancement-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
        }
        
        .enhancement-close:hover {
            color: #ff0000;
        }
        
        .enhancement-section {
            margin-bottom: 15px;
        }
        
        .enhancement-section-title {
            color: #00ff00;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .enhancement-options {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .enhancement-btn {
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }
        
        .enhancement-btn:hover {
            border-color: #00ff00;
            background: #0a2a0a;
        }
        
        .enhancement-btn.processing {
            background: #006600;
            color: #ccffcc;
        }
        
        /* Scrollable Image Navigator */
        .image-navigator {
            position: fixed;
            bottom: 200px;
            left: 20px;
            width: 200px;
            height: 150px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            z-index: 1500;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .image-navigator.show {
            display: block;
            animation: slideInLeft 0.3s ease-out;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .navigator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }
        
        .navigator-title {
            color: #00ff00;
            font-size: 12px;
            font-weight: bold;
        }
        
        .navigator-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
        }
        
        .navigator-close:hover {
            color: #ff0000;
        }
        
        .navigator-content {
            padding: 10px;
            height: calc(100% - 45px);
            overflow-y: auto;
        }
        
        .navigator-thumbnails {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .navigator-thumbnail {
            width: 100%;
            height: 40px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 5px;
            font-size: 10px;
            color: #ccc;
            transition: all 0.3s ease;
        }
        
        .navigator-thumbnail:hover {
            border-color: #00ff00;
            background: #0a2a0a;
        }
        
        .navigator-thumbnail.active {
            border-color: #00ff00;
            background: #006600;
            color: white;
        }
        
        .navigator-thumbnail img {
            width: 30px;
            height: 30px;
            object-fit: cover;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        /* Series Selector Position Controls - Fixed positioning */
        /* Removed as series selector is always at bottom */
        
        .position-btn {
            background: none;
            border: 1px solid #666;
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .position-btn.active {
            background: #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div id="dicom-viewer" class="dicom-viewer">
        <!-- Left Toolbar -->
        <div class="toolbar">
            <div class="tool-buttons">
                <button class="tool-btn active" data-tool="windowing" title="Window/Level">
                    <i class="fas fa-adjust"></i>
                    <span>Window</span>
                </button>
                <button class="tool-btn" data-tool="zoom" title="Zoom">
                    <i class="fas fa-search-plus"></i>
                    <span>Zoom</span>
                </button>
                <button class="tool-btn" data-tool="pan" title="Pan">
                    <i class="fas fa-hand-paper"></i>
                    <span>Pan</span>
                </button>
                <button class="tool-btn" data-tool="measure" title="Measure">
                    <i class="fas fa-ruler"></i>
                    <span>Measure</span>
                </button>
                <button class="tool-btn" data-tool="ellipse" title="Ellipse HU">
                    <i class="fas fa-circle-notch"></i>
                    <span>Ellipse</span>
                </button>
                <button class="tool-btn" data-tool="annotate" title="Annotate">
                    <i class="fas fa-edit"></i>
                    <span>Annotate</span>
                </button>
                <button class="tool-btn" data-tool="crosshair" title="Crosshair">
                    <i class="fas fa-crosshairs"></i>
                    <span>Crosshair</span>
                </button>
                <button class="tool-btn" data-tool="invert" title="Invert">
                    <i class="fas fa-circle"></i>
                    <span>Invert</span>
                </button>
                <button class="tool-btn active" data-tool="high-quality" title="High Quality Mode">
                    <i class="fas fa-eye"></i>
                    <span>HQ</span>
                </button>
                <button class="tool-btn" data-tool="reset" title="Reset">
                    <i class="fas fa-undo"></i>
                    <span>Reset</span>
                </button>
                <button class="tool-btn" data-tool="volume" title="Volume Calculation">
                    <i class="fas fa-calculator"></i>
                    <span>Volume</span>
                </button>
                <button class="tool-btn" data-tool="enhance" title="Image Enhancement">
                    <i class="fas fa-magic"></i>
                    <span>Enhance</span>
                </button>
                <button class="tool-btn" data-tool="navigator" title="Image Navigator">
                    <i class="fas fa-images"></i>
                    <span>Navigator</span>
                </button>
                <button class="tool-btn" data-tool="folder-upload" title="Upload Folder">
                    <i class="fas fa-folder-plus"></i>
                    <span>Folder</span>
                </button>
                <div class="dropdown-tool">
                    <button class="tool-btn dropdown-toggle" data-tool="ai" title="AI Analysis">
                        <i class="fas fa-robot"></i>
                        <span>AI</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <div class="dropdown-menu ai-dropdown">
                        <h4>AI Analysis</h4>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('chest_xray')">
                            <i class="fas fa-lungs"></i> Chest X-Ray Analysis
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('ct_lung')">
                            <i class="fas fa-wind"></i> CT Lung Nodule Detection
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('bone_fracture')">
                            <i class="fas fa-bone"></i> Bone Fracture Detection
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('brain_mri')">
                            <i class="fas fa-brain"></i> Brain MRI Analysis
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('general')">
                            <i class="fas fa-search"></i> General Abnormality Detection
                        </div>
                    </div>
                </div>
                <div class="dropdown-tool">
                    <button class="tool-btn dropdown-toggle" data-tool="3d" title="3D Reconstruction">
                        <i class="fas fa-cube"></i>
                        <span>3D</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <div class="dropdown-menu reconstruction-dropdown">
                        <h4>3D Reconstruction</h4>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('mpr')">
                            <i class="fas fa-th"></i> Multi-Planar Reconstruction (MPR)
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('volume')">
                            <i class="fas fa-cube"></i> Volume Rendering
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('bone')">
                            <i class="fas fa-bone"></i> 3D Bone Reconstruction
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('vessel')">
                            <i class="fas fa-project-diagram"></i> Vessel Analysis (MIP)
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('surface')">
                            <i class="fas fa-layer-group"></i> Surface Rendering
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-controls">
                    <button id="worklist-btn" class="secondary-btn" title="Back to Worklist">
                        <i class="fas fa-list"></i>
                        Worklist
                    </button>
                    <button id="load-dicom-btn" class="primary-btn">
                        <i class="fas fa-folder-open"></i>
                        Load DICOM
                    </button>
                    <button id="series-selector-btn" class="secondary-btn" title="Series Selector">
                        <i class="fas fa-th-large"></i>
                        Series
                    </button>
                    <button id="logout-btn" class="logout-btn" onclick="window.location.href='/accounts/logout/'">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
                <div class="study-info">
                    <div class="patient-info" id="patient-info">
                        Patient: - | Study Date: - | Modality: -
                    </div>
                    <div class="clinical-info-section" id="clinical-info-section" style="display: none;">
                        <div class="clinical-info-header">
                            <h4><i class="fas fa-file-medical"></i> Clinical Information</h4>
                            <button class="btn-toggle" onclick="toggleClinicalInfo()">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="clinical-info-content" id="clinical-info-content">
                            <p id="clinical-info-text">No clinical information available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Viewport -->
            <div class="viewport">
                <canvas id="dicom-canvas" class="dicom-canvas"></canvas>
                
                <!-- Overlay Labels -->
                <div class="overlay-labels">
                    <div class="wl-info" id="wl-info">
                        WW: 400<br>
                        WL: 40<br>
                        Slice: 1/1
                    </div>
                    <div class="zoom-info" id="zoom-info">
                        Zoom: 100%
                    </div>
                </div>

                <!-- Crosshair -->
                <div id="crosshair" class="crosshair" style="display: none;">
                    <div class="crosshair-h"></div>
                    <div class="crosshair-v"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel-content">
                <!-- Window/Level Section -->
                <div class="panel-section">
                    <h3 class="section-title">Window/Level</h3>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <label>Window Width</label>
                            <span id="ww-value">400</span>
                        </div>
                        <input type="range" id="ww-slider" min="1" max="4000" value="400" class="slider">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <label>Window Level</label>
                            <span id="wl-value">40</span>
                        </div>
                        <input type="range" id="wl-slider" min="-1000" max="3000" value="40" class="slider">
                    </div>
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="lung">Lung</button>
                        <button class="preset-btn" data-preset="bone">Bone</button>
                        <button class="preset-btn" data-preset="soft">Soft</button>
                        <button class="preset-btn" data-preset="brain">Brain</button>
                        <button class="preset-btn" data-preset="liver">Liver</button>
                        <button class="preset-btn" data-preset="mediastinum">Mediastinum</button>
                        <button class="preset-btn" data-preset="abdomen">Abdomen</button>
                        <button class="preset-btn" data-preset="cardiac">Cardiac</button>
                        <button class="preset-btn" data-preset="spine">Spine</button>
                        <button class="preset-btn" data-preset="angio">Angio</button>
                    </div>
                </div>

                <!-- Navigation Section -->
                <div class="panel-section">
                    <h3 class="section-title">Navigation</h3>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <label>Slice</label>
                            <span id="slice-info">1/1</span>
                        </div>
                        <input type="range" id="slice-slider" min="1" max="1" value="1" class="slider">
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="nav-btn" id="prev-slice">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-btn" id="next-slice">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Measurements Section -->
                <div class="panel-section">
                    <h3 class="section-title">Measurements</h3>
                    <div id="measurements-list">
                        <p class="no-data">No measurements</p>
                    </div>
                    <button class="clear-btn" id="clear-measurements">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>

                <!-- Annotations Section -->
                <div class="panel-section">
                    <h3 class="section-title">Annotations</h3>
                    <div id="annotations-list">
                        <p class="no-data">No annotations</p>
                    </div>
                    <button class="clear-btn" id="clear-annotations">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple DICOM Upload Modal -->
    <div class="upload-modal" id="upload-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Load DICOM Files</h3>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-tabs">
                    <button class="upload-tab active" onclick="switchUploadTab('files')">
                        <i class="fas fa-file-medical"></i> Files
                    </button>
                    <button class="upload-tab" onclick="switchUploadTab('folder')">
                        <i class="fas fa-folder"></i> Folder
                    </button>
                    <button class="upload-tab" onclick="switchUploadTab('drive')">
                        <i class="fas fa-hdd"></i> Drive/Disc
                    </button>
                    <button class="upload-tab" onclick="switchUploadTab('network')">
                        <i class="fas fa-network-wired"></i> Network
                    </button>
                </div>
                
                <div class="upload-content">
                    <!-- Files Tab -->
                    <div class="upload-tab-content active" id="files-tab">
                        <div class="upload-drop-area" id="files-drop-area" onclick="selectFiles()">
                            <div class="upload-icon">
                                <i class="fas fa-file-medical"></i>
                            </div>
                            <h4>Select DICOM Files</h4>
                            <p>Choose individual DICOM files (.dcm, .dicom, .img, .ima, .raw)</p>
                            <div class="upload-formats">
                                <span class="format-tag">DCM</span>
                                <span class="format-tag">DICOM</span>
                                <span class="format-tag">IMG</span>
                                <span class="format-tag">IMA</span>
                                <span class="format-tag">RAW</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Folder Tab -->
                    <div class="upload-tab-content" id="folder-tab">
                        <div class="upload-drop-area" onclick="selectFolder()">
                            <div class="upload-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <h4>Select DICOM Folder</h4>
                            <p>Choose entire folders containing DICOM studies and series</p>
                            <div class="upload-note">
                                <i class="fas fa-info-circle"></i>
                                Supports nested folders and multiple series
                            </div>
                        </div>
                    </div>
                    
                    <!-- Drive/Disc Tab -->
                    <div class="upload-tab-content" id="drive-tab">
                        <div class="upload-drive-options">
                            <div class="drive-option" onclick="selectDrive('cd')">
                                <i class="fas fa-compact-disc"></i>
                                <h5>CD/DVD</h5>
                                <p>Import from medical imaging CD or DVD</p>
                            </div>
                            <div class="drive-option" onclick="selectDrive('usb')">
                                <i class="fas fa-usb"></i>
                                <h5>USB Drive</h5>
                                <p>Import from USB flash drive or external drive</p>
                            </div>
                            <div class="drive-option" onclick="selectDrive('external')">
                                <i class="fas fa-hdd"></i>
                                <h5>External Drive</h5>
                                <p>Import from external hard drive or SSD</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Tab -->
                    <div class="upload-tab-content" id="network-tab">
                        <div class="network-options">
                            <div class="network-option">
                                <h5><i class="fas fa-server"></i> DICOM Server (PACS)</h5>
                                <div class="network-form">
                                    <input type="text" placeholder="Server IP/Hostname" id="pacs-server">
                                    <input type="text" placeholder="Port (default: 104)" id="pacs-port" value="104">
                                    <input type="text" placeholder="AE Title" id="pacs-ae-title">
                                    <button class="network-connect-btn" onclick="connectToPACS()">
                                        <i class="fas fa-plug"></i> Connect
                                    </button>
                                </div>
                            </div>
                            <div class="network-option">
                                <h5><i class="fas fa-cloud"></i> Cloud Storage</h5>
                                <div class="cloud-providers">
                                    <button class="cloud-btn" onclick="connectToCloud('drive')">
                                        <i class="fab fa-google-drive"></i> Google Drive
                                    </button>
                                    <button class="cloud-btn" onclick="connectToCloud('dropbox')">
                                        <i class="fab fa-dropbox"></i> Dropbox
                                    </button>
                                    <button class="cloud-btn" onclick="connectToCloud('onedrive')">
                                        <i class="fab fa-microsoft"></i> OneDrive
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Uploading...</div>
                </div>
                
                <!-- Hidden file inputs -->
                <input type="file" id="file-input" multiple accept=".dcm,.dicom,.img,.ima,.raw,.dat,.bin" style="display: none;">
                <input type="file" id="folder-input" webkitdirectory style="display: none;">
            </div>
        </div>
    </div>

    <!-- Series Selector -->
    <div class="series-selector" id="series-selector">
        <div class="series-selector-header">
            <div class="series-selector-title">Series Selector</div>
            <button class="series-selector-close" onclick="toggleSeriesSelector()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="series-grid" id="series-grid">
            <!-- Series items will be populated here -->
        </div>
    </div>

    <!-- Image Enhancement Panel -->
    <div class="image-enhancement-panel" id="enhancement-panel">
        <div class="enhancement-header">
            <div class="enhancement-title">Image Enhancement</div>
            <button class="enhancement-close" onclick="toggleEnhancementPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- X-ray Enhancement Section -->
        <div class="enhancement-section">
            <div class="enhancement-section-title">X-ray Enhancement</div>
            <div class="enhancement-options">
                <button class="enhancement-btn" onclick="enhanceXray('comprehensive')">Comprehensive Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceXray('edge_enhancement')">Edge Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceXray('contrast_enhancement')">Contrast Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceXray('noise_reduction')">Noise Reduction</button>
                <button class="enhancement-btn" onclick="enhanceXray('bone_enhancement')">Bone Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceXray('soft_tissue_enhancement')">Soft Tissue Enhancement</button>
            </div>
        </div>
        
        <!-- MRI Enhancement Section -->
        <div class="enhancement-section">
            <div class="enhancement-section-title">MRI Enhancement</div>
            <div class="enhancement-options">
                <button class="enhancement-btn" onclick="enhanceMri('comprehensive')">Comprehensive Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceMri('brain_enhancement')">Brain Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceMri('spine_enhancement')">Spine Enhancement</button>
                <button class="enhancement-btn" onclick="enhanceMri('vessel_enhancement')">Vessel Enhancement</button>
            </div>
        </div>
        
        <!-- MRI Reconstruction Section -->
        <div class="enhancement-section">
            <div class="enhancement-section-title">MRI Reconstruction</div>
            <div class="enhancement-options">
                <button class="enhancement-btn" onclick="reconstructMri('t1_weighted')">T1-Weighted</button>
                <button class="enhancement-btn" onclick="reconstructMri('t2_weighted')">T2-Weighted</button>
                <button class="enhancement-btn" onclick="reconstructMri('flair')">FLAIR</button>
                <button class="enhancement-btn" onclick="reconstructMri('dwi')">Diffusion-Weighted</button>
                <button class="enhancement-btn" onclick="reconstructMri('perfusion')">Perfusion</button>
            </div>
        </div>
    </div>

    <!-- Image Navigator Panel -->
    <div class="image-navigator" id="image-navigator">
        <div class="navigator-header">
            <div class="navigator-title">Image Navigator</div>
            <button class="navigator-close" onclick="toggleImageNavigator()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="navigator-content">
            <div class="navigator-thumbnails" id="navigator-thumbnails">
                <!-- Thumbnails will be populated here -->
            </div>
        </div>
    </div>

    <!-- Series Position Controls -->
    <!-- Removed as series selector is always at bottom -->
    {% comment %}Expose initial study ID for JS initialization{% endcomment %}
    <script>
        // Provide the initial study ID from the Django context to the JS viewer
        window.initialStudyId = {% if initial_study_id %}{{ initial_study_id }}{% else %}null{% endif %};
    </script>
    
    <!-- Main viewer logic -->
    <script src="{% static 'js/dicom_viewer_fixed.js' %}"></script>
    <script>
        // Enhanced upload functionality
        let currentUploadId = null;
        let uploadProgressInterval = null;
        
        // Series selector functionality
        let currentStudyId = null;
        let seriesData = [];
        let currentSeriesId = null;
        
        // Enhanced controls
        let densityEnhancement = false;
        let highResolution = false;
        let contrastBoost = false;
        
        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            initializeSeriesSelector();
            initializeEnhancedControls();
            initializeEnhancementFeatures();
        });
        
        // Enhancement panel functionality
        function initializeEnhancementFeatures() {
            // Add toolbar event listeners
            document.querySelector('[data-tool="enhance"]').addEventListener('click', () => {
                toggleEnhancementPanel();
            });
            
            document.querySelector('[data-tool="navigator"]').addEventListener('click', () => {
                toggleImageNavigator();
            });
            
            document.querySelector('[data-tool="folder-upload"]').addEventListener('click', () => {
                document.getElementById('folder-input').click();
            });
        }
        
        function toggleEnhancementPanel() {
            const panel = document.getElementById('enhancement-panel');
            panel.classList.toggle('show');
        }
        
        function toggleImageNavigator() {
            const navigator = document.getElementById('image-navigator');
            navigator.classList.toggle('show');
            
            if (navigator.classList.contains('show')) {
                loadImageThumbnails();
            }
        }
        
        // X-ray enhancement functions
        function enhanceXray(enhancementType) {
            if (!window.viewer || !window.viewer.currentImageId) {
                alert('Please load an image first');
                return;
            }
            
            const button = event.target;
            button.classList.add('processing');
            button.textContent = 'Processing...';
            
            fetch(`/viewer/api/images/${window.viewer.currentImageId}/enhance-xray/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    enhancement_type: enhancementType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display enhanced image
                    if (window.viewer && window.viewer.displayEnhancedImage) {
                        window.viewer.displayEnhancedImage(data.enhanced_image);
                    }
                    showNotification(`X-ray enhancement applied: ${enhancementType}`, 'success');
                } else {
                    showNotification(`Enhancement failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Enhancement error:', error);
                showNotification('Enhancement failed: Network error', 'error');
            })
            .finally(() => {
                button.classList.remove('processing');
                button.textContent = button.textContent.replace('Processing...', enhancementType.replace('_', ' '));
            });
        }
        
        // MRI enhancement functions
        function enhanceMri(enhancementType) {
            if (!window.viewer || !window.viewer.currentImageId) {
                alert('Please load an image first');
                return;
            }
            
            const button = event.target;
            button.classList.add('processing');
            button.textContent = 'Processing...';
            
            fetch(`/viewer/api/images/${window.viewer.currentImageId}/enhance-mri/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    enhancement_type: enhancementType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display enhanced image
                    if (window.viewer && window.viewer.displayEnhancedImage) {
                        window.viewer.displayEnhancedImage(data.enhanced_image);
                    }
                    showNotification(`MRI enhancement applied: ${enhancementType}`, 'success');
                } else {
                    showNotification(`Enhancement failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Enhancement error:', error);
                showNotification('Enhancement failed: Network error', 'error');
            })
            .finally(() => {
                button.classList.remove('processing');
                button.textContent = button.textContent.replace('Processing...', enhancementType.replace('_', ' '));
            });
        }
        
        // MRI reconstruction functions
        function reconstructMri(reconstructionType) {
            if (!window.viewer || !window.viewer.currentImageId) {
                alert('Please load an image first');
                return;
            }
            
            const button = event.target;
            button.classList.add('processing');
            button.textContent = 'Processing...';
            
            fetch(`/viewer/api/images/${window.viewer.currentImageId}/reconstruct-mri/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    reconstruction_type: reconstructionType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display reconstructed image
                    if (window.viewer && window.viewer.displayEnhancedImage) {
                        window.viewer.displayEnhancedImage(data.reconstructed_image);
                    }
                    showNotification(`MRI reconstruction applied: ${reconstructionType}`, 'success');
                } else {
                    showNotification(`Reconstruction failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Reconstruction error:', error);
                showNotification('Reconstruction failed: Network error', 'error');
            })
            .finally(() => {
                button.classList.remove('processing');
                button.textContent = button.textContent.replace('Processing...', reconstructionType.replace('_', ' '));
            });
        }
        
        // Image navigator functions
        function loadImageThumbnails() {
            if (!window.viewer || !window.viewer.currentSeriesId) {
                return;
            }
            
            const container = document.getElementById('navigator-thumbnails');
            container.innerHTML = '<div style="text-align: center; color: #666;">Loading thumbnails...</div>';
            
            fetch(`/viewer/api/series/${window.viewer.currentSeriesId}/images-scrollable/?per_page=50`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayThumbnails(data.images);
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #f00;">Failed to load thumbnails</div>';
                }
            })
            .catch(error => {
                console.error('Thumbnail loading error:', error);
                container.innerHTML = '<div style="text-align: center; color: #f00;">Error loading thumbnails</div>';
            });
        }
        
        function displayThumbnails(images) {
            const container = document.getElementById('navigator-thumbnails');
            container.innerHTML = '';
            
            images.forEach(image => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'navigator-thumbnail';
                thumbnail.dataset.imageId = image.id;
                
                if (image.thumbnail) {
                    thumbnail.innerHTML = `
                        <img src="${image.thumbnail}" alt="Image ${image.instance_number}">
                        <span>Image ${image.instance_number}</span>
                    `;
                } else {
                    thumbnail.innerHTML = `
                        <div style="width: 30px; height: 30px; background: #333; margin-right: 8px; border-radius: 2px;"></div>
                        <span>Image ${image.instance_number}</span>
                    `;
                }
                
                thumbnail.addEventListener('click', () => {
                    selectThumbnailImage(image.id);
                });
                
                container.appendChild(thumbnail);
            });
        }
        
        function selectThumbnailImage(imageId) {
            // Update active thumbnail
            document.querySelectorAll('.navigator-thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            document.querySelector(`[data-image-id="${imageId}"]`).classList.add('active');
            
            // Load image in viewer
            if (window.viewer && window.viewer.loadImageById) {
                window.viewer.loadImageById(imageId);
            }
        }
        
        // Enhanced folder upload functionality
        document.getElementById('folder-input').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFolderUpload(e.target.files);
            }
        });
        
        function handleFolderUpload(files) {
            const formData = new FormData();
            
            // Add all files to form data
            Array.from(files).forEach(file => {
                formData.append('folder', file);
            });
            
            // Show progress
            showNotification(`Uploading ${files.length} files from folder...`, 'info');
            
            fetch('/viewer/api/upload-folder/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Folder upload initiated. Upload ID: ${data.upload_id}`, 'success');
                    // Start monitoring upload progress
                    monitorUploadProgress(data.upload_id);
                } else {
                    showNotification(`Upload failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showNotification('Upload failed: Network error', 'error');
            });
        }
        
        function monitorUploadProgress(uploadId) {
            const interval = setInterval(() => {
                fetch(`/viewer/api/enhanced-upload-progress/${uploadId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.progress) {
                        const progress = data.progress;
                        showNotification(`Upload progress: ${progress.processed_files}/${progress.total_files} files processed`, 'info');
                        
                        if (progress.status === 'completed' || progress.status === 'failed') {
                            clearInterval(interval);
                            if (progress.status === 'completed') {
                                showNotification('Folder upload completed successfully!', 'success');
                                // Refresh studies list
                                if (window.viewer && window.viewer.refreshStudies) {
                                    window.viewer.refreshStudies();
                                }
                            } else {
                                showNotification('Folder upload failed', 'error');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Progress monitoring error:', error);
                    clearInterval(interval);
                });
            }, 2000); // Check every 2 seconds
        }
        
        // Utility functions
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#006600' : type === 'error' ? '#660000' : '#003366'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 2000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                max-width: 300px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        


        
        // Series selector functionality
        function initializeSeriesSelector() {
            document.getElementById('series-selector-btn').addEventListener('click', toggleSeriesSelector);
            
            // Position controls
            // Removed as series selector is always at bottom
        }
        
        function toggleSeriesSelector() {
            const selector = document.getElementById('series-selector');
            const viewer = document.getElementById('dicom-viewer');
            selector.classList.toggle('show');
            
            // Add class to viewer to adjust viewport
            if (selector.classList.contains('show')) {
                viewer.classList.add('series-selector-open');
                if (currentStudyId) {
                    loadSeriesData(currentStudyId);
                }
            } else {
                viewer.classList.remove('series-selector-open');
            }
            
            // Resize canvas after transition
            setTimeout(() => {
                if (window.viewer) {
                    window.viewer.resizeCanvas();
                }
            }, 300);
        }
        
        // Series position is fixed at bottom, no need for position function
        
        function loadSeriesData(studyId) {
            fetch(`/viewer/api/studies/${studyId}/series-selector/`)
                .then(response => response.json())
                .then(data => {
                    seriesData = data.series;
                    renderSeriesGrid(data.series);
                })
                .catch(error => {
                    console.error('Error loading series data:', error);
                });
        }
        
        function renderSeriesGrid(series) {
            const grid = document.getElementById('series-grid');
            grid.innerHTML = '';
            
            series.forEach(seriesItem => {
                const seriesElement = document.createElement('div');
                seriesElement.className = 'series-item';
                seriesElement.onclick = () => selectSeries(seriesItem.id);
                
                seriesElement.innerHTML = `
                    <img class="series-preview" src="${seriesItem.preview_image || ''}" alt="Series ${seriesItem.series_number}">
                    <div class="series-info">
                        <div class="series-number">${seriesItem.series_number}</div>
                        <div class="series-description">${seriesItem.series_description || 'No description'}</div>
                        <div class="series-count">${seriesItem.image_count} images</div>
                    </div>
                `;
                
                grid.appendChild(seriesElement);
            });
        }
        
        function selectSeries(seriesId) {
            currentSeriesId = seriesId;
            
            // Update active series
            document.querySelectorAll('.series-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.series-item').classList.add('active');
            
            // Load series images
            if (window.viewer && window.viewer.loadSeriesImages) {
                window.viewer.loadSeriesImages(seriesId);
            }
        }
        
        // Enhanced controls
        function initializeEnhancedControls() {
            document.getElementById('density-toggle').addEventListener('click', toggleDensityEnhancement);
            document.getElementById('resolution-toggle').addEventListener('click', toggleHighResolution);
            document.getElementById('contrast-toggle').addEventListener('click', toggleContrastBoost);
        }
        
        function toggleDensityEnhancement() {
            densityEnhancement = !densityEnhancement;
            const btn = document.getElementById('density-toggle');
            btn.textContent = densityEnhancement ? 'On' : 'Off';
            btn.classList.toggle('active', densityEnhancement);
            
            if (window.viewer && window.viewer.refreshImage) {
                window.viewer.refreshImage();
            }
        }
        
        function toggleHighResolution() {
            highResolution = !highResolution;
            const btn = document.getElementById('resolution-toggle');
            btn.textContent = highResolution ? 'On' : 'Off';
            btn.classList.toggle('active', highResolution);
            
            if (window.viewer && window.viewer.refreshImage) {
                window.viewer.refreshImage();
            }
        }
        
        function toggleContrastBoost() {
            contrastBoost = !contrastBoost;
            const btn = document.getElementById('contrast-toggle');
            btn.textContent = contrastBoost ? 'On' : 'Off';
            btn.classList.toggle('active', contrastBoost);
            
            if (window.viewer && window.viewer.refreshImage) {
                window.viewer.refreshImage();
            }
        }
        
        // Load DICOM button
        document.getElementById('load-dicom-btn').addEventListener('click', () => {
            document.getElementById('upload-modal').style.display = 'flex';
        });
        
        // Close upload on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUploadModal();
            }
        });
        
        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
        }
        
        function selectFiles() {
            document.getElementById('file-input').click();
        }
        
        function selectFolder() {
            document.getElementById('folder-input').click();
        }
        
        // Handle file selection
        document.getElementById('file-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files);
            }
        });
        
        document.getElementById('folder-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files);
            }
        });
        
        function handleFileUpload(files) {
            closeUploadModal();
            
            // Show progress indicator
            showUploadProgress(true);
            
            if (window.viewer && window.viewer.uploadDicomFiles) {
                console.log(`Starting upload of ${files.length} files`);
                window.viewer.uploadDicomFiles(files);
            } else {
                console.log('Viewer not ready or upload method not available');
                showUploadProgress(false);
                alert('Viewer not ready. Please try again.');
            }
        }
        
        function showUploadProgress(show) {
            // Create or show upload progress indicator
            let progressDiv = document.getElementById('upload-progress');
            if (!progressDiv && show) {
                progressDiv = document.createElement('div');
                progressDiv.id = 'upload-progress';
                progressDiv.innerHTML = `
                    <div class="progress-content">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Uploading DICOM files...</span>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                `;
                progressDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 20000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                `;
                document.body.appendChild(progressDiv);
            }
            
            if (progressDiv) {
                progressDiv.style.display = show ? 'flex' : 'none';
                if (!show) {
                    setTimeout(() => {
                        if (progressDiv.parentNode) {
                            progressDiv.parentNode.removeChild(progressDiv);
                        }
                    }, 500);
                }
            }
        }

        // Enhanced dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Handle dropdown toggles
            document.querySelectorAll('.dropdown-toggle').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Close all other dropdowns
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        if (menu !== this.nextElementSibling) {
                            menu.style.display = 'none';
                        }
                    });
                    
                    // Toggle current dropdown
                    const menu = this.nextElementSibling;
                    if (menu && menu.classList.contains('dropdown-menu')) {
                        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });
            
            // Handle dropdown item clicks
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Add visual feedback
                    this.style.background = 'rgba(0, 255, 0, 0.3)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 200);
                    
                    // Close dropdown after selection
                    const dropdown = this.closest('.dropdown-menu');
                    if (dropdown) {
                        dropdown.style.display = 'none';
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            });
            
            // Enhanced 3D reconstruction with better error handling
            window.apply3DReconstruction = function(type) {
                if (window.viewer) {
                    try {
                        window.viewer.apply3DReconstruction(type);
                    } catch (error) {
                        console.error('3D reconstruction error:', error);
                        if (window.viewer.showError) {
                            window.viewer.showError('3D reconstruction failed: ' + error.message);
                        } else {
                            alert('3D reconstruction failed: ' + error.message);
                        }
                    }
                } else {
                    console.error('DICOM viewer not initialized');
                    alert('Please wait for the viewer to initialize');
                }
            };
            
            // Performance monitoring for debugging
            if (window.performance && window.performance.mark) {
                window.performance.mark('viewer-dom-ready');
            }
        });
    </script>
</body>
</html>