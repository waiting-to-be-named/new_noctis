<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django DICOM Viewer</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dicom_viewer.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="dicom-viewer" class="dicom-viewer">
        <!-- Left Toolbar -->
        <div class="toolbar">
            <div class="tool-buttons">
                <button class="tool-btn active" data-tool="windowing" title="Window/Level">
                    <i class="fas fa-adjust"></i>
                    <span>Window</span>
                </button>
                <button class="tool-btn" data-tool="zoom" title="Zoom">
                    <i class="fas fa-search-plus"></i>
                    <span>Zoom</span>
                </button>
                <button class="tool-btn" data-tool="pan" title="Pan">
                    <i class="fas fa-hand-paper"></i>
                    <span>Pan</span>
                </button>
                <button class="tool-btn" data-tool="measure" title="Measure">
                    <i class="fas fa-ruler"></i>
                    <span>Measure</span>
                </button>
                <button class="tool-btn" data-tool="annotate" title="Annotate">
                    <i class="fas fa-edit"></i>
                    <span>Annotate</span>
                </button>
                <button class="tool-btn" data-tool="crosshair" title="Crosshair">
                    <i class="fas fa-crosshairs"></i>
                    <span>Crosshair</span>
                </button>
                <button class="tool-btn" data-tool="invert" title="Invert">
                    <i class="fas fa-circle"></i>
                    <span>Invert</span>
                </button>
                <button class="tool-btn" data-tool="reset" title="Reset">
                    <i class="fas fa-undo"></i>
                    <span>Reset</span>
                </button>
                <button class="tool-btn" data-tool="ai" title="AI Analysis">
                    <i class="fas fa-robot"></i>
                    <span>AI</span>
                </button>
                <button class="tool-btn" data-tool="3d" title="3D Reconstruction">
                    <i class="fas fa-cube"></i>
                    <span>3D</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-controls">
                    <button id="load-dicom-btn" class="primary-btn">
                        <i class="fas fa-upload"></i>
                        Load DICOM Files
                    </button>
                    <button id="worklist-btn" class="primary-btn">
                        <i class="fas fa-list"></i>
                        Worklist
                    </button>
                    <select id="backend-studies" class="form-select">
                        <option value="">Select DICOM from System</option>
                    </select>
                    <div class="patient-info" id="patient-info">
                        Patient: - | Study Date: - | Modality: -
                    </div>
                </div>
            </div>

            <!-- Viewport -->
            <div class="viewport">
                <canvas id="dicom-canvas" class="dicom-canvas"></canvas>
                
                <!-- Overlay Labels -->
                <div class="overlay-labels">
                    <div class="wl-info" id="wl-info">
                        WW: 400<br>
                        WL: 40<br>
                        Slice: 1/1
                    </div>
                    <div class="zoom-info" id="zoom-info">
                        Zoom: 100%
                    </div>
                </div>

                <!-- Crosshair -->
                <div id="crosshair" class="crosshair" style="display: none;">
                    <div class="crosshair-h"></div>
                    <div class="crosshair-v"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Controls -->
            <div class="controls-panel">
                <h3>Controls</h3>
                
                <!-- Window/Level Controls -->
                <div class="control-group">
                    <label>Window Width</label>
                    <input type="range" id="ww-slider" min="1" max="4000" value="400" class="slider">
                    <span id="ww-value">400</span>
                </div>
                
                <div class="control-group">
                    <label>Window Level</label>
                    <input type="range" id="wl-slider" min="-1000" max="1000" value="40" class="slider">
                    <span id="wl-value">40</span>
                </div>
                
                <div class="control-group">
                    <label>Slice</label>
                    <input type="range" id="slice-slider" min="0" max="0" value="0" class="slider">
                    <span id="slice-value">1/1</span>
                </div>
                
                <div class="control-group">
                    <label>Zoom</label>
                    <input type="range" id="zoom-slider" min="10" max="500" value="100" class="slider">
                    <span id="zoom-value">100%</span>
                </div>
                
                <!-- Presets -->
                <div class="presets">
                    <h4>Window Presets</h4>
                    <button class="preset-btn" data-preset="lung">Lung</button>
                    <button class="preset-btn" data-preset="bone">Bone</button>
                    <button class="preset-btn" data-preset="soft">Soft Tissue</button>
                    <button class="preset-btn" data-preset="brain">Brain</button>
                </div>
            </div>
            
            <!-- Measurement Panel -->
            <div class="measurement-panel">
                <h3>Measurements</h3>
                <div class="measurement-controls">
                    <button id="clear-measurements" class="btn btn-secondary">Clear All</button>
                </div>
                <div id="measurements-list" class="measurements-list"></div>
            </div>
            
            <!-- Annotations Panel -->
            <div class="annotations-panel">
                <h3>Annotations</h3>
                <div id="annotations-list" class="annotations-list"></div>
            </div>
        </div>
    </div>

    <!-- Worklist Modal -->
    <div id="worklist-modal" class="modal">
        <div class="modal-content worklist-content">
            <div class="modal-header">
                <h3>Patient Worklist</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="worklist-filters">
                    <input type="text" id="patient-search" placeholder="Search patients..." class="form-input">
                    <select id="facility-filter" class="form-select">
                        <option value="">All Facilities</option>
                    </select>
                    <select id="modality-filter" class="form-select">
                        <option value="">All Modalities</option>
                        <option value="CT">CT</option>
                        <option value="MR">MR</option>
                        <option value="XR">XR</option>
                        <option value="US">US</option>
                    </select>
                </div>
                <div class="worklist-table">
                    <table id="patients-table">
                        <thead>
                            <tr>
                                <th>Patient Name</th>
                                <th>Patient ID</th>
                                <th>Study Date</th>
                                <th>Modality</th>
                                <th>Facility</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="patients-tbody">
                            <!-- Patient rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal">
        <div class="modal-content report-content">
            <div class="modal-header">
                <h3>Radiology Report</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="report-form">
                    <div class="form-group">
                        <label>Clinical Information</label>
                        <textarea id="clinical-info" class="form-textarea" placeholder="Enter clinical information..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Findings</label>
                        <textarea id="findings" class="form-textarea" placeholder="Enter findings..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Impression</label>
                        <textarea id="impression" class="form-textarea" placeholder="Enter impression..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Recommendation</label>
                        <textarea id="recommendation" class="form-textarea" placeholder="Enter recommendation..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-report">Save Report</button>
                <button class="btn btn-secondary" id="print-report">Print Report</button>
                <button class="btn btn-secondary" id="cancel-report">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notification-panel" class="notification-panel">
        <div class="notification-header">
            <h4>Notifications</h4>
            <button class="close-notifications">&times;</button>
        </div>
        <div id="notifications-list" class="notifications-list">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <script src="{% static 'js/dicom_viewer.js' %}"></script>
    <script>
        // Worklist functionality
        document.getElementById('worklist-btn').addEventListener('click', () => {
            document.getElementById('worklist-modal').style.display = 'block';
            loadWorklist();
        });

        // Close modals
        document.querySelectorAll('.close').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.modal').style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        async function loadWorklist() {
            try {
                const response = await fetch('/api/worklist/');
                const data = await response.json();
                
                const tbody = document.getElementById('patients-tbody');
                tbody.innerHTML = '';
                
                data.patients.forEach(patient => {
                    const row = document.createElement('tr');
                    row.className = patient.facility === '{{ user.facility }}' ? 'facility-patient' : '';
                    row.innerHTML = `
                        <td>${patient.patient_name}</td>
                        <td>${patient.patient_id}</td>
                        <td>${patient.study_date}</td>
                        <td>${patient.modality}</td>
                        <td>${patient.facility}</td>
                        <td><span class="status-${patient.status}">${patient.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewPatient(${patient.study_id})">View</button>
                            ${patient.status === 'new' ? '<button class="btn btn-sm btn-success" onclick="createReport(${patient.study_id})">Report</button>' : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading worklist:', error);
            }
        }

        function viewPatient(studyId) {
            document.getElementById('worklist-modal').style.display = 'none';
            if (window.viewer) {
                window.viewer.loadStudy(studyId);
            }
        }

        function createReport(studyId) {
            document.getElementById('worklist-modal').style.display = 'none';
            document.getElementById('report-modal').style.display = 'block';
            // Load patient data for report
            loadPatientForReport(studyId);
        }

        async function loadPatientForReport(studyId) {
            try {
                const response = await fetch(`/api/studies/${studyId}/`);
                const data = await response.json();
                
                // Pre-fill report with patient information
                document.getElementById('clinical-info').value = `Patient: ${data.patient_name}\nPatient ID: ${data.patient_id}\nStudy Date: ${data.study_date}`;
            } catch (error) {
                console.error('Error loading patient data:', error);
            }
        }

        // Report functionality
        document.getElementById('save-report').addEventListener('click', async () => {
            const reportData = {
                clinical_info: document.getElementById('clinical-info').value,
                findings: document.getElementById('findings').value,
                impression: document.getElementById('impression').value,
                recommendation: document.getElementById('recommendation').value
            };
            
            try {
                const response = await fetch('/api/reports/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify(reportData)
                });
                
                if (response.ok) {
                    alert('Report saved successfully!');
                    document.getElementById('report-modal').style.display = 'none';
                }
            } catch (error) {
                console.error('Error saving report:', error);
            }
        });

        document.getElementById('print-report').addEventListener('click', () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Radiology Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                            .section { margin: 15px 0; }
                            .section h3 { margin-bottom: 5px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Radiology Report</h1>
                            <p>Generated on ${new Date().toLocaleDateString()}</p>
                        </div>
                        <div class="section">
                            <h3>Clinical Information</h3>
                            <p>${document.getElementById('clinical-info').value}</p>
                        </div>
                        <div class="section">
                            <h3>Findings</h3>
                            <p>${document.getElementById('findings').value}</p>
                        </div>
                        <div class="section">
                            <h3>Impression</h3>
                            <p>${document.getElementById('impression').value}</p>
                        </div>
                        <div class="section">
                            <h3>Recommendation</h3>
                            <p>${document.getElementById('recommendation').value}</p>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="close-notification">&times;</button>
            `;
            
            document.getElementById('notifications-list').appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
            
            // Close button
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.remove();
            });
        }

        // Check for new uploads periodically
        setInterval(async () => {
            try {
                const response = await fetch('/api/notifications/');
                const data = await response.json();
                
                if (data.new_uploads > 0) {
                    showNotification(`${data.new_uploads} new upload(s) available`, 'success');
                }
            } catch (error) {
                console.error('Error checking notifications:', error);
            }
        }, 30000); // Check every 30 seconds
    </script>
</body>
</html>