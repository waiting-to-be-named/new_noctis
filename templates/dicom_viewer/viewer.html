<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noctis - Enhanced DICOM Viewer</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dicom_viewer.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Enhanced viewer UI refinements */
        body {
            overflow: hidden;
            background: #000;
        }
        
        .dicom-viewer {
            background: #000;
        }
        
        /* Better button styles */
        .tool-btn {
            transition: all 0.3s ease;
        }
        
        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }
        
        /* Enhanced viewport appearance */
        .viewport {
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000 70%);
            border: 1px solid rgba(0, 255, 0, 0.1);
            transition: margin-bottom 0.3s ease;
            image-rendering: optimizeQuality;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* High-quality canvas rendering */
        #dicom-canvas {
            image-rendering: auto;
            image-rendering: crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            will-change: transform;
        }
        
        /* Adjust viewport when series selector is shown */
        .dicom-viewer.series-selector-open .viewport {
            margin-bottom: 180px;
        }
        
        /* Better patient info display */
        .patient-info {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
            padding: 12px 20px;
            font-size: 14px;
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        
        /* Enhanced slider styling */
        .slider-control input[type="range"] {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .slider-control input[type="range"]:hover {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .slider-control .value {
            color: #00ff00;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.5);
        }
        
        /* Enhanced overlay labels */
        .overlay-label {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 4px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 255, 0, 0.2);
            font-size: 12px;
            line-height: 1.4;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .overlay-label.top-left,
        .overlay-label.top-right {
            top: 70px;
        }
        
        .overlay-label.bottom-left,
        .overlay-label.bottom-right {
            bottom: 20px;
        }
        
        /* Enhanced Series Selector Styles */
        .series-selector {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.95));
            color: white;
            padding: 15px;
            z-index: 12000;
            display: none;
            border-top: 2px solid #00ff00;
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }
        
        .series-selector.show {
            display: block;
            animation: slideUpFadeIn 0.3s ease-out;
        }
        
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Remove old position-specific styles */
        
        .series-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .series-selector-title {
            font-size: 16px;
            font-weight: bold;
            color: #00ff00;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .series-selector-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .series-selector-close:hover {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }
        
        .series-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .series-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 150px;
            flex-shrink: 0;
        }
        
        .series-item:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 0, 0.2);
        }
        
        .series-item.active {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .series-preview {
            width: 130px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 8px;
            background: #000;
            display: block;
        }
        
        .series-info {
            font-size: 11px;
            line-height: 1.3;
        }
        
        .series-number {
            font-weight: bold;
            color: #00ff00;
            font-size: 12px;
        }
        
        .series-description {
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 3px;
        }
        
        .series-count {
            color: #888;
            font-size: 10px;
            margin-top: 2px;
        }
        
        /* Simple Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            color: white;
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #00ff00;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #ff0000;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .upload-option-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .upload-option-btn:hover {
            border-color: #00ff00;
            background: #0a2a0a;
        }
        
        .upload-option-btn i {
            font-size: 24px;
            color: #00ff00;
            min-width: 30px;
        }
        
        .upload-option-btn span {
            font-size: 16px;
            font-weight: bold;
            display: block;
        }
        
        .upload-option-btn small {
            font-size: 12px;
            color: #888;
            display: block;
            margin-top: 2px;
        }
        

        

        
        /* Enhanced Controls */
        .enhanced-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-label {
            font-size: 12px;
            color: #666;
        }
        
        .control-toggle {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .control-toggle.active {
            background: #28a745;
        }
        
        /* Series Selector Position Controls - Fixed positioning */
        /* Removed as series selector is always at bottom */
        
        .position-btn {
            background: none;
            border: 1px solid #666;
            color: white;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .position-btn.active {
            background: #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div id="dicom-viewer" class="dicom-viewer">
        <!-- Left Toolbar -->
        <div class="toolbar">
            <div class="tool-buttons">
                <button class="tool-btn active" data-tool="windowing" title="Window/Level">
                    <i class="fas fa-adjust"></i>
                    <span>Window</span>
                </button>
                <button class="tool-btn" data-tool="zoom" title="Zoom">
                    <i class="fas fa-search-plus"></i>
                    <span>Zoom</span>
                </button>
                <button class="tool-btn" data-tool="pan" title="Pan">
                    <i class="fas fa-hand-paper"></i>
                    <span>Pan</span>
                </button>
                <button class="tool-btn" data-tool="measure" title="Measure">
                    <i class="fas fa-ruler"></i>
                    <span>Measure</span>
                </button>
                <button class="tool-btn" data-tool="ellipse" title="Ellipse HU">
                    <i class="fas fa-circle-notch"></i>
                    <span>Ellipse</span>
                </button>
                <button class="tool-btn" data-tool="annotate" title="Annotate">
                    <i class="fas fa-edit"></i>
                    <span>Annotate</span>
                </button>
                <button class="tool-btn" data-tool="crosshair" title="Crosshair">
                    <i class="fas fa-crosshairs"></i>
                    <span>Crosshair</span>
                </button>
                <button class="tool-btn" data-tool="invert" title="Invert">
                    <i class="fas fa-circle"></i>
                    <span>Invert</span>
                </button>
                <button class="tool-btn active" data-tool="high-quality" title="High Quality Mode">
                    <i class="fas fa-eye"></i>
                    <span>HQ</span>
                </button>
                <button class="tool-btn" data-tool="reset" title="Reset">
                    <i class="fas fa-undo"></i>
                    <span>Reset</span>
                </button>
                <button class="tool-btn" data-tool="volume" title="Volume Calculation">
                    <i class="fas fa-calculator"></i>
                    <span>Volume</span>
                </button>
                <div class="dropdown-tool">
                    <button class="tool-btn dropdown-toggle" data-tool="ai" title="AI Analysis">
                        <i class="fas fa-robot"></i>
                        <span>AI</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <div class="dropdown-menu ai-dropdown">
                        <h4>AI Analysis</h4>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('chest_xray')">
                            <i class="fas fa-lungs"></i> Chest X-Ray Analysis
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('ct_lung')">
                            <i class="fas fa-wind"></i> CT Lung Nodule Detection
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('bone_fracture')">
                            <i class="fas fa-bone"></i> Bone Fracture Detection
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('brain_mri')">
                            <i class="fas fa-brain"></i> Brain MRI Analysis
                        </div>
                        <div class="dropdown-item" onclick="viewer.performAIAnalysis('general')">
                            <i class="fas fa-search"></i> General Abnormality Detection
                        </div>
                    </div>
                </div>
                <div class="dropdown-tool">
                    <button class="tool-btn dropdown-toggle" data-tool="3d" title="3D Reconstruction">
                        <i class="fas fa-cube"></i>
                        <span>3D</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>
                    <div class="dropdown-menu reconstruction-dropdown">
                        <h4>3D Reconstruction</h4>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('mpr')">
                            <i class="fas fa-th"></i> Multi-Planar Reconstruction (MPR)
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('volume')">
                            <i class="fas fa-cube"></i> Volume Rendering
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('bone')">
                            <i class="fas fa-bone"></i> 3D Bone Reconstruction
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('vessel')">
                            <i class="fas fa-project-diagram"></i> Vessel Analysis (MIP)
                        </div>
                        <div class="dropdown-item" onclick="viewer.apply3DReconstruction('surface')">
                            <i class="fas fa-layer-group"></i> Surface Rendering
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-controls">
                    <button id="worklist-btn" class="secondary-btn" title="Back to Worklist">
                        <i class="fas fa-list"></i>
                        Worklist
                    </button>
                    <button id="load-dicom-btn" class="primary-btn">
                        <i class="fas fa-folder-open"></i>
                        Load DICOM
                    </button>
                    <button id="series-selector-btn" class="secondary-btn" title="Series Selector">
                        <i class="fas fa-th-large"></i>
                        Series
                    </button>
                    <button id="logout-btn" class="logout-btn" onclick="window.location.href='/accounts/logout/'">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
                <div class="study-info">
                    <div class="patient-info" id="patient-info">
                        Patient: - | Study Date: - | Modality: -
                    </div>
                    <div class="clinical-info-section" id="clinical-info-section" style="display: none;">
                        <div class="clinical-info-header">
                            <h4><i class="fas fa-file-medical"></i> Clinical Information</h4>
                            <button class="btn-toggle" onclick="toggleClinicalInfo()">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="clinical-info-content" id="clinical-info-content">
                            <p id="clinical-info-text">No clinical information available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Viewport -->
            <div class="viewport">
                <canvas id="dicom-canvas" class="dicom-canvas"></canvas>
                
                <!-- Overlay Labels -->
                <div class="overlay-labels">
                    <div class="wl-info" id="wl-info">
                        WW: 400<br>
                        WL: 40<br>
                        Slice: 1/1
                    </div>
                    <div class="zoom-info" id="zoom-info">
                        Zoom: 100%
                    </div>
                </div>

                <!-- Crosshair -->
                <div id="crosshair" class="crosshair" style="display: none;">
                    <div class="crosshair-h"></div>
                    <div class="crosshair-v"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel-content">
                <!-- Enhanced Controls -->
                <div class="panel-section">
                    <h3 class="section-title">Enhanced Density Processing</h3>
                    <div class="enhanced-controls">
                        <div class="control-group">
                            <label class="control-label">Auto Tissue Detection</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="detected-tissue-type" style="color: #00ff00; font-weight: bold; font-size: 12px;">Unknown</span>
                                <button class="control-toggle" id="auto-enhance-toggle" style="background-color: #004400; font-size: 10px;">Auto</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Auto Tissue Detection</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="detected-tissue-type" style="color: #00ff00; font-weight: bold; font-size: 12px;">Unknown</span>
                                <button class="control-toggle" id="auto-enhance-toggle" style="background-color: #004400; font-size: 10px;">Auto</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Density Enhancement</label>
                            <button class="control-toggle" id="density-toggle" style="background-color: #004400;">On</button>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Resolution Factor</label>
                            <div class="slider-control">
                                <input type="range" id="resolution-factor" min="1.0" max="2.0" step="0.1" value="1.25">
                                <span class="value" id="resolution-factor-value">1.25x</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Contrast Boost</label>
                            <div class="slider-control">
                                <input type="range" id="contrast-boost" min="0.8" max="1.5" step="0.05" value="1.15">
                                <span class="value" id="contrast-boost-value">1.15x</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Density Level</label>
                            <div class="slider-control">
                                <input type="range" id="density-level" min="0.5" max="2.0" step="0.1" value="1.2">
                                <span class="value" id="density-level-value">1.2x</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Tissue Brightness</label>
                            <div class="slider-control">
                                <input type="range" id="tissue-brightness" min="80" max="125" step="1" value="100">
                                <span class="value" id="tissue-brightness-value">100%</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Tissue Contrast</label>
                            <div class="slider-control">
                                <input type="range" id="tissue-contrast" min="85" max="165" step="1" value="100">
                                <span class="value" id="tissue-contrast-value">100%</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Gamma Correction</label>
                            <div class="slider-control">
                                <input type="range" id="gamma-correction" min="0.5" max="1.5" step="0.05" value="1.0">
                                <span class="value" id="gamma-correction-value">1.0</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Edge Enhancement</label>
                            <button class="control-toggle" id="edge-enhancement-toggle" style="background-color: #004400;">On</button>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Noise Reduction</label>
                            <button class="control-toggle" id="noise-reduction-toggle" style="background-color: #004400;">On</button>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Medical Presets</label>
                            <select id="density-presets" style="width: 100%; background: rgba(0, 0, 0, 0.8); color: #00ff00; border: 1px solid rgba(0, 255, 0, 0.3); padding: 5px; border-radius: 3px;">
                                <option value="">Select Enhanced Preset</option>
                                <option value="lung-enhanced">Lung Tissue (Enhanced)</option>
                                <option value="bone-enhanced">Bone Tissue (Enhanced)</option>
                                <option value="soft-enhanced">Soft Tissue (Enhanced)</option>
                                <option value="brain-enhanced">Brain Tissue (Enhanced)</option>
                                <option value="abdomen-enhanced">Abdomen (Enhanced)</option>
                                <option value="cardiac-enhanced">Cardiac (Enhanced)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Window/Level Section -->
                <div class="panel-section">
                    <h3 class="section-title">Window/Level</h3>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <label>Window Width</label>
                            <span id="ww-value">400</span>
                        </div>
                        <input type="range" id="ww-slider" min="1" max="4000" value="400" class="slider">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <label>Window Level</label>
                            <span id="wl-value">40</span>
                        </div>
                        <input type="range" id="wl-slider" min="-1000" max="1000" value="40" class="slider">
                    </div>
                    
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="lung" title="WW: 1500, WL: -600 - Enhanced contrast for air vs soft tissue">Lung</button>
                        <button class="preset-btn" data-preset="bone" title="WW: 2000, WL: 300 - High contrast for bone vs soft tissue">Bone</button>
                        <button class="preset-btn" data-preset="soft" title="WW: 400, WL: 40 - Optimized for organ differentiation">Soft</button>
                        <button class="preset-btn" data-preset="brain" title="WW: 100, WL: 50 - Fine detail in neural tissue">Brain</button>
                        <button class="preset-btn" data-preset="liver" title="WW: 150, WL: 60 - Hepatic lesion detection">Liver</button>
                        <button class="preset-btn" data-preset="mediastinum" title="WW: 400, WL: 20 - Vessel and tissue contrast">Mediastinum</button>
                        <button class="preset-btn" data-preset="abdomen" title="WW: 350, WL: 50 - Organ and vessel contrast">Abdomen</button>
                        <button class="preset-btn" data-preset="cardiac" title="WW: 600, WL: 200 - Heart muscle and vessels">Cardiac</button>
                        <button class="preset-btn" data-preset="spine" title="WW: 1000, WL: 400 - Bone and disc contrast">Spine</button>
                        <button class="preset-btn" data-preset="angio" title="WW: 700, WL: 150 - Vessel enhancement">Angio</button>
                    </div>
                </div>

                <!-- Navigation Section -->
                <div class="panel-section">
                    <h3 class="section-title">Navigation</h3>
                    
                    <div class="control-group">
                        <div class="control-header">
                            <label>Slice</label>
                            <span id="slice-info">1/1</span>
                        </div>
                        <input type="range" id="slice-slider" min="1" max="1" value="1" class="slider">
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="nav-btn" id="prev-slice">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-btn" id="next-slice">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Measurements Section -->
                <div class="panel-section">
                    <h3 class="section-title">Measurements</h3>
                    <div id="measurements-list">
                        <p class="no-data">No measurements</p>
                    </div>
                    <button class="clear-btn" id="clear-measurements">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>

                <!-- Annotations Section -->
                <div class="panel-section">
                    <h3 class="section-title">Annotations</h3>
                    <div id="annotations-list">
                        <p class="no-data">No annotations</p>
                    </div>
                    <button class="clear-btn" id="clear-annotations">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple DICOM Upload Modal -->
    <div class="upload-modal" id="upload-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Load DICOM Files</h3>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-options">
                    <button class="upload-option-btn" onclick="selectFiles()">
                        <i class="fas fa-file-medical"></i>
                        <span>Select DICOM Files</span>
                        <small>Choose individual DICOM files</small>
                    </button>
                    <button class="upload-option-btn" onclick="selectFolder()">
                        <i class="fas fa-folder"></i>
                        <span>Select Folder</span>
                        <small>Choose folder containing DICOM files</small>
                    </button>
                </div>
                <input type="file" id="file-input" multiple accept=".dcm,.dicom,.img,.ima" style="display: none;">
                <input type="file" id="folder-input" webkitdirectory style="display: none;">
            </div>
        </div>
    </div>

    <!-- Series Selector -->
    <div class="series-selector" id="series-selector">
        <div class="series-selector-header">
            <div class="series-selector-title">Series Selector</div>
            <button class="series-selector-close" onclick="toggleSeriesSelector()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="series-grid" id="series-grid">
            <!-- Series items will be populated here -->
        </div>
    </div>

    <!-- Series Position Controls -->
    <!-- Removed as series selector is always at bottom -->
    {% comment %}Expose initial study ID for JS initialization{% endcomment %}
    <script>
        // Provide the initial study ID from the Django context to the JS viewer
        window.initialStudyId = {% if initial_study_id %}{{ initial_study_id }}{% else %}null{% endif %};
    </script>
    
    <!-- Main viewer logic -->
    <script src="{% static 'js/dicom_viewer_fixed.js' %}"></script>
    <script>
        // Enhanced upload functionality
        let currentUploadId = null;
        let uploadProgressInterval = null;
        
        // Series selector functionality
        let currentStudyId = null;
        let seriesData = [];
        let currentSeriesId = null;
        
        // Enhanced controls
        let densityEnhancement = false;
        let highResolution = false;
        let contrastBoost = false;
        
        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            initializeSeriesSelector();
            initializeEnhancedControls();
        });
        


        
        // Series selector functionality
        function initializeSeriesSelector() {
            document.getElementById('series-selector-btn').addEventListener('click', toggleSeriesSelector);
            
            // Position controls
            // Removed as series selector is always at bottom
        }
        
        function toggleSeriesSelector() {
            const selector = document.getElementById('series-selector');
            const viewer = document.getElementById('dicom-viewer');
            selector.classList.toggle('show');
            
            // Add class to viewer to adjust viewport
            if (selector.classList.contains('show')) {
                viewer.classList.add('series-selector-open');
                if (currentStudyId) {
                    loadSeriesData(currentStudyId);
                }
            } else {
                viewer.classList.remove('series-selector-open');
            }
            
            // Resize canvas after transition
            setTimeout(() => {
                if (window.viewer) {
                    window.viewer.resizeCanvas();
                }
            }, 300);
        }
        
        // Series position is fixed at bottom, no need for position function
        
        function loadSeriesData(studyId) {
            fetch(`/viewer/api/studies/${studyId}/series-selector/`)
                .then(response => response.json())
                .then(data => {
                    seriesData = data.series;
                    renderSeriesGrid(data.series);
                })
                .catch(error => {
                    console.error('Error loading series data:', error);
                });
        }
        
        function renderSeriesGrid(series) {
            const grid = document.getElementById('series-grid');
            grid.innerHTML = '';
            
            series.forEach(seriesItem => {
                const seriesElement = document.createElement('div');
                seriesElement.className = 'series-item';
                seriesElement.onclick = () => selectSeries(seriesItem.id);
                
                seriesElement.innerHTML = `
                    <img class="series-preview" src="${seriesItem.preview_image || ''}" alt="Series ${seriesItem.series_number}">
                    <div class="series-info">
                        <div class="series-number">${seriesItem.series_number}</div>
                        <div class="series-description">${seriesItem.series_description || 'No description'}</div>
                        <div class="series-count">${seriesItem.image_count} images</div>
                    </div>
                `;
                
                grid.appendChild(seriesElement);
            });
        }
        
        function selectSeries(seriesId) {
            currentSeriesId = seriesId;
            
            // Update active series
            document.querySelectorAll('.series-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.series-item').classList.add('active');
            
            // Load series images
            if (window.viewer && window.viewer.loadSeriesImages) {
                window.viewer.loadSeriesImages(seriesId);
            }
        }
        
        // Enhanced controls
        function initializeEnhancedControls() {
            document.getElementById('density-toggle').addEventListener('click', toggleDensityEnhancement);
            document.getElementById('resolution-toggle').addEventListener('click', toggleHighResolution);
            document.getElementById('contrast-toggle').addEventListener('click', toggleContrastBoost);
        }
        
        function toggleDensityEnhancement() {
            densityEnhancement = !densityEnhancement;
            const btn = document.getElementById('density-toggle');
            btn.textContent = densityEnhancement ? 'On' : 'Off';
            btn.classList.toggle('active', densityEnhancement);
            
            if (window.viewer && window.viewer.refreshImage) {
                window.viewer.refreshImage();
            }
        }
        
        function toggleHighResolution() {
            highResolution = !highResolution;
            const btn = document.getElementById('resolution-toggle');
            btn.textContent = highResolution ? 'On' : 'Off';
            btn.classList.toggle('active', highResolution);
            
            if (window.viewer && window.viewer.refreshImage) {
                window.viewer.refreshImage();
            }
        }
        
        function toggleContrastBoost() {
            contrastBoost = !contrastBoost;
            const btn = document.getElementById('contrast-toggle');
            btn.textContent = contrastBoost ? 'On' : 'Off';
            btn.classList.toggle('active', contrastBoost);
            
            if (window.viewer && window.viewer.refreshImage) {
                window.viewer.refreshImage();
            }
        }
        
        // Load DICOM button
        document.getElementById('load-dicom-btn').addEventListener('click', () => {
            document.getElementById('upload-modal').style.display = 'flex';
        });
        
        // Close upload on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeUploadModal();
            }
        });
        
        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
        }
        
        function selectFiles() {
            document.getElementById('file-input').click();
        }
        
        function selectFolder() {
            document.getElementById('folder-input').click();
        }
        
        // Handle file selection
        document.getElementById('file-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files);
            }
        });
        
        document.getElementById('folder-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files);
            }
        });
        
        function handleFileUpload(files) {
            closeUploadModal();
            
            // Show progress indicator
            showUploadProgress(true);
            
            if (window.viewer && window.viewer.uploadDicomFiles) {
                console.log(`Starting upload of ${files.length} files`);
                window.viewer.uploadDicomFiles(files);
            } else {
                console.log('Viewer not ready or upload method not available');
                showUploadProgress(false);
                alert('Viewer not ready. Please try again.');
            }
        }
        
        function showUploadProgress(show) {
            // Create or show upload progress indicator
            let progressDiv = document.getElementById('upload-progress');
            if (!progressDiv && show) {
                progressDiv = document.createElement('div');
                progressDiv.id = 'upload-progress';
                progressDiv.innerHTML = `
                    <div class="progress-content">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Uploading DICOM files...</span>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                `;
                progressDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 20000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                `;
                document.body.appendChild(progressDiv);
            }
            
            if (progressDiv) {
                progressDiv.style.display = show ? 'flex' : 'none';
                if (!show) {
                    setTimeout(() => {
                        if (progressDiv.parentNode) {
                            progressDiv.parentNode.removeChild(progressDiv);
                        }
                    }, 500);
                }
            }
        }
    </script>
</body>
</html>