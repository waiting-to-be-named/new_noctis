<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ facility.name }} - Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/worklist.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="worklist-container">
        <!-- Top Navigation Bar -->
        <div class="top-nav">
            <div class="nav-left">
                <h1><i class="fas fa-building"></i> {{ facility.name }} Dashboard</h1>
                <span class="facility-name">{{ facility.address|default:"Medical Facility" }}</span>
            </div>
            <div class="nav-center">
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search patients, studies..." class="search-input">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="nav-right">
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="location.href='{% url "viewer:worklist" %}'">
                        <i class="fas fa-list"></i> Worklist
                    </button>
                    <button class="btn btn-secondary" onclick="printReport()" id="print-btn">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-files-medical"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ studies.count }}</h3>
                    <p>Total Studies</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file-medical-alt"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ recent_reports.count }}</h3>
                    <p>Recent Reports</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ studies|length }}</h3>
                    <p>Pending Studies</p>
                </div>
            </div>
        </div>

        <!-- Recent Studies Table -->
        <div class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-history"></i> Recent Studies</h2>
                <div class="filter-controls">
                    <select id="modality-filter" class="filter-select">
                        <option value="">All Modalities</option>
                        <option value="CT">CT</option>
                        <option value="MRI">MRI</option>
                        <option value="CR">CR</option>
                        <option value="DR">DR</option>
                        <option value="US">US</option>
                        <option value="XA">XA</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="studies-table">
                    <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Patient ID</th>
                            <th>Study Date</th>
                            <th>Modality</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studies-tbody">
                        {% for study in studies %}
                        <tr class="study-row" data-study-id="{{ study.id }}">
                            <td class="patient-name">{{ study.patient_name }}</td>
                            <td class="patient-id">{{ study.patient_id }}</td>
                            <td class="study-date">{{ study.study_date|date:"Y-m-d" }}</td>
                            <td class="modality">
                                <span class="modality-badge modality-{{ study.modality|lower }}">{{ study.modality }}</span>
                            </td>
                            <td class="description">{{ study.study_description|truncatewords:6 }}</td>
                            <td class="status">
                                <span class="status-badge status-{{ study.is_processed|yesno:"reported,new" }}">
                                    {{ study.is_processed|yesno:"Reported,New" }}
                                </span>
                            </td>
                            <td class="actions">
                                <button class="btn btn-sm btn-primary view-btn" onclick="viewStudy({{ study.id }})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                {% if study.is_processed %}
                                <button class="btn btn-sm btn-secondary print-btn" onclick="printStudyReport({{ study.id }})">
                                    <i class="fas fa-print"></i> Print
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="no-data">No studies found for this facility</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Reports Section -->
        {% if recent_reports %}
        <div class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-file-medical"></i> Recent Reports</h2>
            </div>
            
            <div class="reports-grid">
                {% for report in recent_reports %}
                <div class="report-card" data-report-id="{{ report.id }}">
                    <div class="report-header">
                        <h4>{{ report.study.patient_name }}</h4>
                        <span class="report-date">{{ report.finalized_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="report-content">
                        <p><strong>Study:</strong> {{ report.study.modality }} - {{ report.study.study_description|truncatewords:5 }}</p>
                        <p><strong>Radiologist:</strong> {{ report.radiologist.get_full_name|default:report.radiologist.username }}</p>
                        <div class="report-status">
                            <span class="status-badge status-finalized">{{ report.get_status_display }}</span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-sm btn-secondary" onclick="printReport({{ report.id }})">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Print Preview Modal -->
    <div id="print-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-print"></i> Print Preview</h3>
                <button class="modal-close" onclick="closePrintModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-preview" id="print-preview">
                    <!-- Print content will be loaded here -->
                </div>
                <div class="print-actions">
                    <button class="btn btn-secondary" onclick="closePrintModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="executePrint()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Search functionality
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.study-row');
            
            rows.forEach(row => {
                const patientName = row.querySelector('.patient-name').textContent.toLowerCase();
                const patientId = row.querySelector('.patient-id').textContent.toLowerCase();
                
                if (patientName.includes(searchTerm) || patientId.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Modality filter
        document.getElementById('modality-filter').addEventListener('change', function(e) {
            const selectedModality = e.target.value;
            const rows = document.querySelectorAll('.study-row');
            
            rows.forEach(row => {
                const modality = row.querySelector('.modality-badge').textContent;
                
                if (!selectedModality || modality === selectedModality) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Navigation functions
        function viewStudy(studyId) {
            window.location.href = `/launch-viewer/${studyId}/`;
        }

        function printReport(reportId = null) {
            if (reportId) {
                // Print specific report
                loadReportForPrint(reportId);
            } else {
                // Print facility summary
                printFacilitySummary();
            }
        }

        function printStudyReport(studyId) {
            // Print report for specific study
            window.open(`/api/studies/${studyId}/report/print/`, '_blank');
        }

        function loadReportForPrint(reportId) {
            document.getElementById('print-modal').style.display = 'flex';
            
            // Load report content
            fetch(`/api/reports/${reportId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('print-preview').innerHTML = generateReportHTML(data);
                })
                .catch(error => {
                    console.error('Error loading report:', error);
                    document.getElementById('print-preview').innerHTML = '<p>Error loading report</p>';
                });
        }

        function printFacilitySummary() {
            const printWindow = window.open('', '_blank');
            const facilityName = '{{ facility.name }}';
            const currentDate = new Date().toLocaleDateString();
            
            const summaryHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Facility Summary - ${facilityName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .logo { height: 60px; margin-bottom: 10px; }
                        .section { margin: 20px 0; }
                        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                        .stat { text-align: center; }
                        .stat h3 { font-size: 24px; color: #27ae60; margin: 0; }
                        .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .table th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${facilityName}</h1>
                        <p>{{ facility.address|default:"Medical Facility" }}</p>
                        <p>Facility Report - ${currentDate}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat">
                            <h3>{{ studies.count }}</h3>
                            <p>Total Studies</p>
                        </div>
                        <div class="stat">
                            <h3>{{ recent_reports.count }}</h3>
                            <p>Reports</p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Recent Studies Summary</h2>
                        <!-- Add study summary table here -->
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(summaryHTML);
            printWindow.document.close();
            printWindow.print();
        }

        function generateReportHTML(reportData) {
            return `
                <div class="report-print">
                    <div class="report-header">
                        <h1>{{ facility.name }}</h1>
                        <h2>RADIOLOGY REPORT</h2>
                    </div>
                    <div class="report-details">
                        <p><strong>Patient:</strong> ${reportData.patient_name}</p>
                        <p><strong>Study Date:</strong> ${reportData.study_date}</p>
                        <p><strong>Modality:</strong> ${reportData.modality}</p>
                    </div>
                    <div class="report-body">
                        <h3>FINDINGS</h3>
                        <p>${reportData.findings || 'No findings documented.'}</p>
                        
                        <h3>IMPRESSION</h3>
                        <p>${reportData.impression || 'No impression documented.'}</p>
                        
                        <h3>RECOMMENDATIONS</h3>
                        <p>${reportData.recommendations || 'No recommendations documented.'}</p>
                    </div>
                    <div class="report-footer">
                        <p><strong>Radiologist:</strong> ${reportData.radiologist_name}</p>
                        <p><strong>Report Date:</strong> ${reportData.finalized_at}</p>
                    </div>
                </div>
            `;
        }

        function closePrintModal() {
            document.getElementById('print-modal').style.display = 'none';
        }

        function executePrint() {
            const printContent = document.getElementById('print-preview').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .report-print { max-width: 800px; margin: 0 auto; }
                        .report-header { text-align: center; margin-bottom: 30px; }
                        .report-details { margin: 20px 0; }
                        .report-body { margin: 20px 0; }
                        .report-body h3 { color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .report-footer { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
            closePrintModal();
        }
    </script>
</body>
</html>