<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Viewer Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        #dicom-canvas { border: 1px solid #ccc; background: #000; width: 512px; height: 512px; }
        .viewport { width: 512px; height: 512px; }
        .test-buttons { margin: 10px 0; }
        .test-buttons button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>DICOM Viewer Debug</h1>
    
    <div class="debug-info">
        <h3>Debug Information</h3>
        <div id="debug-output"></div>
    </div>
    
    <div class="test-buttons">
        <button onclick="testAPI()">Test API</button>
        <button onclick="testImageLoading()">Test Image Loading</button>
        <button onclick="testCanvas()">Test Canvas</button>
        <button onclick="testViewer()">Test Viewer</button>
    </div>
    
    <div class="viewport">
        <canvas id="dicom-canvas" class="dicom-canvas"></canvas>
    </div>
    
    <script>
        // Debug logging
        const debugOutput = document.getElementById('debug-output');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addDebugMessage(message, type = 'success') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            debugOutput.appendChild(div);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addDebugMessage('LOG: ' + args.join(' '), 'success');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addDebugMessage('ERROR: ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addDebugMessage('WARN: ' + args.join(' '), 'warning');
        };
        
        // Set initial study ID
        window.initialStudyId = 5;
        
        console.log('Page loaded, initialStudyId:', window.initialStudyId);
        console.log('Canvas element:', document.getElementById('dicom-canvas'));
        
        // Test functions
        async function testAPI() {
            console.log('Testing API endpoints...');
            try {
                const response = await fetch('/viewer/api/studies/5/images/');
                const data = await response.json();
                console.log('API Response:', data);
                console.log('Images found:', data.images ? data.images.length : 0);
            } catch (error) {
                console.error('API test failed:', error);
            }
        }
        
        async function testImageLoading() {
            console.log('Testing image loading...');
            try {
                const response = await fetch('/viewer/api/images/1/data/?window_width=400&window_level=40');
                const data = await response.json();
                console.log('Image data received, length:', data.image_data ? data.image_data.length : 0);
                
                if (data.image_data) {
                    const img = new Image();
                    img.onload = () => console.log('Image loaded successfully, dimensions:', img.width, 'x', img.height);
                    img.onerror = (e) => console.error('Image failed to load:', e);
                    img.src = data.image_data;
                }
            } catch (error) {
                console.error('Image loading test failed:', error);
            }
        }
        
        function testCanvas() {
            console.log('Testing canvas...');
            const canvas = document.getElementById('dicom-canvas');
            const ctx = canvas.getContext('2d');
            
            // Test drawing
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 100, 100);
            console.log('Canvas test drawing completed');
        }
        
        function testViewer() {
            console.log('Testing viewer object...');
            if (window.viewer) {
                console.log('Viewer exists:', window.viewer);
                console.log('Current study:', window.viewer.currentStudy);
                console.log('Current images:', window.viewer.currentImages);
                console.log('Current image:', window.viewer.currentImage);
                console.log('Canvas:', window.viewer.canvas);
            } else {
                console.error('Viewer object not found');
            }
        }
    </script>
    
    <script src="/static/js/dicom_viewer.js"></script>
    
    <script>
        // Additional debugging after viewer loads
        setTimeout(() => {
            console.log('=== Post-Load Debug ===');
            console.log('Viewer object:', window.viewer);
            if (window.viewer) {
                console.log('Viewer currentStudy:', window.viewer.currentStudy);
                console.log('Viewer currentImages:', window.viewer.currentImages);
                console.log('Viewer currentImage:', window.viewer.currentImage);
                console.log('Viewer canvas:', window.viewer.canvas);
                console.log('Viewer ctx:', window.viewer.ctx);
            }
        }, 3000);
    </script>
</body>
</html>