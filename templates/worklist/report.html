<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noctis - Radiology Report</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/worklist.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .report-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .report-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .study-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .study-info h3 {
            margin-top: 0;
            color: #333;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-group textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }
        
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-draft {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-finalized {
            background: #00b894;
            color: white;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <h1><i class="fas fa-file-medical"></i> Radiology Report</h1>
            <a href="/worklist/" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Worklist
            </a>
        </div>
        
        <div class="study-info">
            <h3>Study Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Patient Name</span>
                    <span class="info-value">{{ study.patient_name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Patient ID</span>
                    <span class="info-value">{{ study.patient_id }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Study Date</span>
                    <span class="info-value">{{ study.study_date }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Modality</span>
                    <span class="info-value">{{ study.modality }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Study Description</span>
                    <span class="info-value">{{ study.study_description|default:"N/A" }}</span>
                </div>
                {% if study.clinical_info %}
                <div class="info-item" style="grid-column: 1 / -1;">
                    <span class="info-label">Clinical Information</span>
                    <div class="info-value" style="white-space: pre-wrap; background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 5px;">{{ study.clinical_info }}</div>
                </div>
                {% endif %}
                {% if report %}
                <div class="info-item">
                    <span class="info-label">Report Status</span>
                    <span class="status-badge status-{{ report.status }}">{{ report.get_status_display }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div id="alert-container"></div>
        
        <form id="report-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="findings">Findings</label>
                <textarea id="findings" name="findings" placeholder="Describe the imaging findings...">{% if report %}{{ report.findings }}{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label for="impression">Impression</label>
                <textarea id="impression" name="impression" placeholder="Clinical impression and diagnosis...">{% if report %}{{ report.impression }}{% endif %}</textarea>
            </div>
            
            <div class="form-group">
                <label for="recommendations">Recommendations</label>
                <textarea id="recommendations" name="recommendations" placeholder="Clinical recommendations and follow-up...">{% if report %}{{ report.recommendations }}{% endif %}</textarea>
            </div>
            
            <div class="button-group">
                <div>
                    <button type="button" id="save-draft" class="btn btn-secondary">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="button" id="finalize-report" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> Finalize Report
                    </button>
                </div>
                <div>
                    {% if report and report.status == 'finalized' %}
                    <a href="{% url 'worklist:print_report' report.id %}" class="btn btn-secondary" target="_blank">
                        <i class="fas fa-print"></i> Print Report
                    </a>
                    {% endif %}
                    <a href="/viewer/study/{{ study.id }}/" class="btn btn-secondary">
                        <i class="fas fa-eye"></i> View Images
                    </a>
                </div>
            </div>
        </form>
    </div>
    
    <script>
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
        
        function saveReport(finalize = false) {
            const findings = document.getElementById('findings').value;
            const impression = document.getElementById('impression').value;
            const recommendations = document.getElementById('recommendations').value;
            
            const data = {
                findings: findings,
                impression: impression,
                recommendations: recommendations,
                finalize: finalize
            };
            
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(finalize ? 'Report finalized successfully!' : 'Report saved as draft!');
                    if (finalize) {
                        // Refresh page to show updated status
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                } else {
                    showAlert(data.error || 'Error saving report', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error saving report', 'error');
            });
        }
        
        document.getElementById('save-draft').addEventListener('click', () => {
            saveReport(false);
        });
        
        document.getElementById('finalize-report').addEventListener('click', () => {
            if (confirm('Are you sure you want to finalize this report? This action cannot be undone.')) {
                saveReport(true);
            }
        });
        
        // Auto-save draft every 30 seconds
        setInterval(() => {
            const findings = document.getElementById('findings').value;
            const impression = document.getElementById('impression').value;
            const recommendations = document.getElementById('recommendations').value;
            
            if (findings.trim() || impression.trim() || recommendations.trim()) {
                saveReport(false);
            }
        }, 30000);
    </script>
</body>
</html>