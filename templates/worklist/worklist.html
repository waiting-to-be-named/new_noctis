<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoctisView - Patient Worklist</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/worklist.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="worklist-container">
        <!-- Header -->
        <header class="worklist-header">
            <div class="header-left">
                <h1><i class="fas fa-list"></i> Patient Worklist</h1>
                <span class="facility-name">
                    {% if user_facility %}{{ user_facility.name }}{% else %}All Facilities{% endif %}
                </span>
            </div>
            <div class="header-right">
                <button id="viewer-btn" class="btn btn-primary" onclick="window.location.href='/'">
                    <i class="fas fa-eye"></i>
                    DICOM Viewer
                </button>
                {% if user_role == 'facility' %}
                <button id="facility-dashboard-btn" class="btn btn-secondary" onclick="window.location.href='/worklist/facility/'">
                    <i class="fas fa-building"></i>
                    Facility Dashboard
                </button>
                {% endif %}
                {% if user_role == 'radiologist' or user_role == 'admin' %}
                <button id="radiologist-dashboard-btn" class="btn btn-secondary" onclick="window.location.href='/worklist/radiologist/'">
                    <i class="fas fa-user-md"></i>
                    Radiologist Dashboard
                </button>
                {% endif %}
                <div class="notification-badge" id="notification-badge" style="display: none;">
                    <i class="fas fa-bell"></i>
                    <span class="badge-count">0</span>
                </div>
            </div>
        </header>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filter-group">
                <label>Status:</label>
                <select id="status-filter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Priority:</label>
                <select id="priority-filter" class="filter-select">
                    <option value="">All Priorities</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="normal">Normal</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date:</label>
                <input type="date" id="date-filter" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Search:</label>
                <input type="text" id="search-filter" class="filter-input" placeholder="Patient name, ID, or accession">
            </div>
            <button id="refresh-btn" class="btn btn-secondary">
                <i class="fas fa-sync"></i>
                Refresh
            </button>
        </div>

        <!-- Worklist Table -->
        <div class="worklist-table-container">
            <table class="worklist-table" id="worklist-table">
                <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Patient ID</th>
                        <th>DOB</th>
                        <th>Sex</th>
                        <th>Study Date</th>
                        <th>Modality</th>
                        <th>Study Description</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="worklist-body">
                    <!-- Patient entries will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Loading indicator -->
        <div id="loading-indicator" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            Loading...
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>No patients found</h3>
            <p>No patients match your current filters</p>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div id="patient-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Patient Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="patient-details">
                <!-- Patient details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Clinical Information Modal -->
    <div id="clinical-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Clinical Information</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clinical-form">
                    <div class="form-group">
                        <label>Referring Physician:</label>
                        <input type="text" id="referring-physician" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Study Description:</label>
                        <input type="text" id="study-description" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Body Part:</label>
                        <input type="text" id="body-part" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Clinical History:</label>
                        <textarea id="clinical-history" class="form-textarea" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Indication:</label>
                        <textarea id="indication" class="form-textarea" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="closeClinicalModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal" style="display: none;">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Report</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="report-section">
                    <div id="existing-reports">
                        <!-- Existing reports will be shown here -->
                    </div>
                    
                    {% if user_role == 'radiologist' or user_role == 'admin' %}
                    <div class="report-form-section">
                        <h4>Create New Report</h4>
                        <form id="report-form">
                            <div class="form-group">
                                <label>Report Text:</label>
                                <textarea id="report-text" class="form-textarea" rows="10" placeholder="Enter report findings..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Impression:</label>
                                <textarea id="impression" class="form-textarea" rows="5" placeholder="Enter clinical impression..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Status:</label>
                                <select id="report-status" class="form-select">
                                    <option value="draft">Draft</option>
                                    <option value="preliminary">Preliminary</option>
                                    <option value="final">Final</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Report</button>
                                <button type="button" class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div id="notification-panel" class="notification-panel" style="display: none;">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button onclick="closeNotificationPanel()" class="close-btn">&times;</button>
        </div>
        <div class="notification-list" id="notification-list">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <!-- CSRF Token -->
    {% csrf_token %}

    <script>
        // Global variables
        let currentEntryId = null;
        let worklistData = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadWorklist();
            setupEventListeners();
            checkNotifications();
            
            // Check notifications every 30 seconds
            setInterval(checkNotifications, 30000);
        });
        
        function setupEventListeners() {
            // Filter listeners
            document.getElementById('status-filter').addEventListener('change', filterWorklist);
            document.getElementById('priority-filter').addEventListener('change', filterWorklist);
            document.getElementById('date-filter').addEventListener('change', filterWorklist);
            document.getElementById('search-filter').addEventListener('input', filterWorklist);
            document.getElementById('refresh-btn').addEventListener('click', loadWorklist);
            
            // Modal close listeners
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal').style.display = 'none';
                });
            });
            
            // Clinical form submission
            document.getElementById('clinical-form').addEventListener('submit', saveClinicalInfo);
            
            // Report form submission
            const reportForm = document.getElementById('report-form');
            if (reportForm) {
                reportForm.addEventListener('submit', saveReport);
            }
            
            // Notification badge click
            document.getElementById('notification-badge').addEventListener('click', toggleNotificationPanel);
        }
        
        async function loadWorklist() {
            showLoading(true);
            
            try {
                const response = await fetch('/worklist/api/worklist/');
                if (response.ok) {
                    worklistData = await response.json();
                    displayWorklist(worklistData);
                } else {
                    throw new Error('Failed to load worklist');
                }
            } catch (error) {
                console.error('Error loading worklist:', error);
                showError('Error loading worklist: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function displayWorklist(data) {
            const tbody = document.getElementById('worklist-body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            }
            
            document.getElementById('empty-state').style.display = 'none';
            
            data.forEach(entry => {
                const row = document.createElement('tr');
                row.className = `priority-${entry.priority}`;
                
                if (entry.has_images) {
                    row.classList.add('has-images');
                }
                
                row.innerHTML = `
                    <td class="patient-name" onclick="showPatientDetails(${entry.id})">${entry.patient_name}</td>
                    <td>${entry.patient_id}</td>
                    <td>${entry.patient_dob || '-'}</td>
                    <td>${entry.patient_sex || '-'}</td>
                    <td>${entry.study_date}</td>
                    <td class="modality">${entry.modality}</td>
                    <td>${entry.study_description}</td>
                    <td><span class="priority-badge priority-${entry.priority}">${entry.priority}</span></td>
                    <td><span class="status-badge status-${entry.status}">${entry.status}</span></td>
                    <td class="actions">
                        ${entry.has_images ? 
                            `<button class="btn btn-primary btn-sm" onclick="launchViewer(${entry.id})">
                                <i class="fas fa-eye"></i> View
                            </button>` :
                            `<button class="btn btn-secondary btn-sm" disabled>
                                <i class="fas fa-clock"></i> Pending
                            </button>`
                        }
                        <button class="btn btn-secondary btn-sm" onclick="showClinicalInfo(${entry.id})">
                            <i class="fas fa-edit"></i> Clinical
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showReports(${entry.id})">
                            <i class="fas fa-file-alt"></i> Report
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function filterWorklist() {
            const statusFilter = document.getElementById('status-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();
            
            let filteredData = worklistData.filter(entry => {
                if (statusFilter && entry.status !== statusFilter) return false;
                if (priorityFilter && entry.priority !== priorityFilter) return false;
                if (dateFilter && entry.study_date !== dateFilter) return false;
                if (searchFilter && 
                    !entry.patient_name.toLowerCase().includes(searchFilter) &&
                    !entry.patient_id.toLowerCase().includes(searchFilter) &&
                    !entry.accession_number.toLowerCase().includes(searchFilter)) {
                    return false;
                }
                return true;
            });
            
            displayWorklist(filteredData);
        }
        
        async function launchViewer(entryId) {
            try {
                const response = await fetch(`/worklist/api/worklist/${entryId}/launch/`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.viewer_url) {
                        window.open(result.viewer_url, '_blank');
                    }
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to launch viewer');
                }
            } catch (error) {
                console.error('Error launching viewer:', error);
                showError('Error launching viewer');
            }
        }
        
        function showPatientDetails(entryId) {
            const entry = worklistData.find(e => e.id === entryId);
            if (!entry) return;
            
            const detailsHtml = `
                <div class="patient-details">
                    <div class="detail-group">
                        <h4>Patient Information</h4>
                        <div class="detail-item"><label>Name:</label> <span>${entry.patient_name}</span></div>
                        <div class="detail-item"><label>ID:</label> <span>${entry.patient_id}</span></div>
                        <div class="detail-item"><label>DOB:</label> <span>${entry.patient_dob || 'Not provided'}</span></div>
                        <div class="detail-item"><label>Sex:</label> <span>${entry.patient_sex || 'Not provided'}</span></div>
                    </div>
                    <div class="detail-group">
                        <h4>Study Information</h4>
                        <div class="detail-item"><label>Date:</label> <span>${entry.study_date}</span></div>
                        <div class="detail-item"><label>Time:</label> <span>${entry.study_time || 'Not provided'}</span></div>
                        <div class="detail-item"><label>Modality:</label> <span>${entry.modality}</span></div>
                        <div class="detail-item"><label>Description:</label> <span>${entry.study_description}</span></div>
                        <div class="detail-item"><label>Body Part:</label> <span>${entry.body_part || 'Not specified'}</span></div>
                        <div class="detail-item"><label>Referring Physician:</label> <span>${entry.referring_physician || 'Not provided'}</span></div>
                    </div>
                    <div class="detail-group">
                        <h4>Status</h4>
                        <div class="detail-item"><label>Priority:</label> <span class="priority-badge priority-${entry.priority}">${entry.priority}</span></div>
                        <div class="detail-item"><label>Status:</label> <span class="status-badge status-${entry.status}">${entry.status}</span></div>
                        <div class="detail-item"><label>Images Available:</label> <span>${entry.has_images ? 'Yes' : 'No'}</span></div>
                    </div>
                </div>
            `;
            
            document.getElementById('patient-details').innerHTML = detailsHtml;
            document.getElementById('patient-modal').style.display = 'flex';
        }
        
        function showClinicalInfo(entryId) {
            currentEntryId = entryId;
            const entry = worklistData.find(e => e.id === entryId);
            if (!entry) return;
            
            // Populate form
            document.getElementById('referring-physician').value = entry.referring_physician || '';
            document.getElementById('study-description').value = entry.study_description || '';
            document.getElementById('body-part').value = entry.body_part || '';
            document.getElementById('clinical-history').value = '';
            document.getElementById('indication').value = '';
            
            document.getElementById('clinical-modal').style.display = 'flex';
        }
        
        async function saveClinicalInfo(e) {
            e.preventDefault();
            
            if (!currentEntryId) return;
            
            const formData = {
                referring_physician: document.getElementById('referring-physician').value,
                study_description: document.getElementById('study-description').value,
                body_part: document.getElementById('body-part').value,
                clinical_history: document.getElementById('clinical-history').value,
                indication: document.getElementById('indication').value
            };
            
            try {
                const response = await fetch(`/worklist/api/worklist/${currentEntryId}/clinical-info/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Clinical information saved successfully');
                    closeClinicalModal();
                    loadWorklist(); // Refresh the list
                } else {
                    throw new Error('Failed to save clinical information');
                }
            } catch (error) {
                console.error('Error saving clinical info:', error);
                showError('Error saving clinical information');
            }
        }
        
        async function showReports(entryId) {
            currentEntryId = entryId;
            
            try {
                const response = await fetch(`/worklist/api/worklist/${entryId}/reports/`);
                if (response.ok) {
                    const reports = await response.json();
                    displayReports(reports);
                    document.getElementById('report-modal').style.display = 'flex';
                } else {
                    throw new Error('Failed to load reports');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                showError('Error loading reports');
            }
        }
        
        function displayReports(reports) {
            const container = document.getElementById('existing-reports');
            
            if (reports.length === 0) {
                container.innerHTML = '<p>No reports available</p>';
                return;
            }
            
            let html = '<h4>Existing Reports</h4>';
            reports.forEach(report => {
                html += `
                    <div class="report-item">
                        <div class="report-header">
                            <span class="report-status status-${report.status}">${report.status}</span>
                            <span class="report-date">${new Date(report.created_at).toLocaleDateString()}</span>
                            <span class="report-author">by ${report.created_by_username}</span>
                            <button class="btn btn-sm btn-secondary" onclick="printReport(${report.id})">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <div class="report-content">
                            <div class="report-section">
                                <strong>Report:</strong>
                                <p>${report.report_text}</p>
                            </div>
                            ${report.impression ? 
                                `<div class="report-section">
                                    <strong>Impression:</strong>
                                    <p>${report.impression}</p>
                                </div>` : ''
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function saveReport(e) {
            e.preventDefault();
            
            if (!currentEntryId) return;
            
            const formData = {
                report_text: document.getElementById('report-text').value,
                impression: document.getElementById('impression').value,
                status: document.getElementById('report-status').value
            };
            
            try {
                const response = await fetch(`/worklist/api/worklist/${currentEntryId}/reports/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Report saved successfully');
                    document.getElementById('report-form').reset();
                    showReports(currentEntryId); // Refresh reports
                } else {
                    throw new Error('Failed to save report');
                }
            } catch (error) {
                console.error('Error saving report:', error);
                showError('Error saving report');
            }
        }
        
        async function printReport(reportId) {
            try {
                const response = await fetch(`/worklist/api/reports/${reportId}/print/`);
                if (response.ok) {
                    const htmlContent = await response.text();
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(htmlContent);
                    printWindow.document.close();
                    printWindow.print();
                } else {
                    throw new Error('Failed to generate print report');
                }
            } catch (error) {
                console.error('Error printing report:', error);
                showError('Error printing report');
            }
        }
        
        async function checkNotifications() {
            try {
                const response = await fetch('/worklist/api/notifications/');
                if (response.ok) {
                    const notifications = await response.json();
                    updateNotificationBadge(notifications.length);
                    displayNotifications(notifications);
                }
            } catch (error) {
                console.error('Error checking notifications:', error);
            }
        }
        
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            const countElement = badge.querySelector('.badge-count');
            
            if (count > 0) {
                badge.style.display = 'block';
                countElement.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }
        
        function displayNotifications(notifications) {
            const list = document.getElementById('notification-list');
            
            if (notifications.length === 0) {
                list.innerHTML = '<p>No new notifications</p>';
                return;
            }
            
            let html = '';
            notifications.forEach(notification => {
                html += `
                    <div class="notification-item">
                        <div class="notification-header">
                            <strong>${notification.title}</strong>
                            <button onclick="markNotificationRead(${notification.id})" class="close-notification">Ã—</button>
                        </div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${new Date(notification.created_at).toLocaleString()}</div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`/worklist/api/notifications/${notificationId}/read/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                if (response.ok) {
                    checkNotifications(); // Refresh notifications
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeNotificationPanel() {
            document.getElementById('notification-panel').style.display = 'none';
        }
        
        function closeClinicalModal() {
            document.getElementById('clinical-modal').style.display = 'none';
            currentEntryId = null;
        }
        
        function closeReportModal() {
            document.getElementById('report-modal').style.display = 'none';
            currentEntryId = null;
        }
        
        function showLoading(show) {
            document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            // Simple alert for now - could be enhanced with a toast notification
            alert('Error: ' + message);
        }
        
        function showSuccess(message) {
            // Simple alert for now - could be enhanced with a toast notification
            alert(message);
        }
        
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    </script>
</body>
</html>